---
alwaysApply: true
priority: 9
techStack: "FastAdmin LDCMS MultiLanguage"
contextPatterns:
  - "addons/ldcms"
  - "å¤šè¯­è¨€"
  - "multilang"
  - "lang"
  - "zh-cn"
  - "en"
  - "zh-tw"
  - "LanguageHandler"
  - "MultiLanguageConfig"
---

# FastAdmin LDCMS å¤šè¯­è¨€å¼€å‘æ ‡å‡†è§„èŒƒ

> **ğŸ¯ ä¸“ä¸ºLDCMSæ’ä»¶è®¾è®¡**: åŸºäºFastAdmin LDCMSä¼ä¸šç½‘ç«™ç®¡ç†ç³»ç»Ÿçš„å¤šè¯­è¨€å¼€å‘è§„èŒƒ
> **ğŸŒ æ”¯æŒè¯­è¨€**: ä¸­æ–‡(zh-cn)ã€è‹±æ–‡(en)ã€ç¹ä½“ä¸­æ–‡(zh-tw)ã€æ—¥æ–‡(ja)ã€éŸ©æ–‡(ko)
> **ğŸ”§ æŠ€æœ¯å®ç°**: LDCMSæ’ä»¶çš„æ•°æ®åº“å¤šè¯­è¨€ã€æ¨¡æ¿å¤šè¯­è¨€ã€URLå¤šè¯­è¨€
> **âš ï¸ é‡è¦**: æ‰€æœ‰å¤šè¯­è¨€åŠŸèƒ½éƒ½å¿…é¡»åŸºäºLDCMSæ’ä»¶çš„ç°æœ‰æ¶æ„è¿›è¡Œå¼€å‘

---

## ğŸŒ å¤šè¯­è¨€æ¶æ„è®¾è®¡

## ğŸš¨ LDCMSå¤šè¯­è¨€å¼€å‘å¼ºåˆ¶è¦æ±‚

**æ‰€æœ‰å¤šè¯­è¨€åŠŸèƒ½å¼€å‘å¿…é¡»éµå¾ªä»¥ä¸‹LDCMSæ’ä»¶è§„èŒƒï¼š**

1. **ğŸ”¥ ä½¿ç”¨LDCMSç°æœ‰çš„è¯­è¨€è¡¨**: å¿…é¡»åŸºäº `fa_ldcms_langs` è¡¨è¿›è¡Œè¯­è¨€ç®¡ç†
2. **ğŸ”¥ éµå¾ªLDCMSçš„è¯­è¨€ä»£ç è§„èŒƒ**: zh-cn, en, zh-tw ç­‰
3. **ğŸ”¥ ä½¿ç”¨LDCMSçš„æ¨¡æ¿è¯­è¨€ç›®å½•**: `addons/ldcms/view/{template}/` ç»“æ„
4. **ğŸ”¥ é›†æˆLDCMSçš„è¯­è¨€åˆ‡æ¢æœºåˆ¶**: ä¸ç°æœ‰çš„è¯­è¨€åˆ‡æ¢åŠŸèƒ½å…¼å®¹
5. **ğŸ”¥ ä½¿ç”¨LDCMSçš„URLè¯­è¨€å‰ç¼€**: éµå¾ªç°æœ‰çš„URLç»“æ„è§„èŒƒ

### LDCMSæ’ä»¶è¯­è¨€é…ç½®ä½“ç³»
```php
/**
 * LDCMSå¤šè¯­è¨€é…ç½®ç®¡ç†ï¼ˆåŸºäºç°æœ‰LDCMSæ’ä»¶ï¼‰
 * ä½ç½®ï¼šaddons/ldcms/utils/LanguageConfig.php
 */
class LdcmsLanguageConfig
{
    /**
     * æ”¯æŒçš„è¯­è¨€é…ç½®
     */
    public static function getLanguageConfig()
    {
        return [
            'zh-cn' => [
                'name' => 'ç®€ä½“ä¸­æ–‡',
                'native_name' => 'ç®€ä½“ä¸­æ–‡',
                'locale' => 'zh-CN',
                'flag' => 'cn',
                'direction' => 'ltr',
                'default' => true,
                'enabled' => true,
                'domain' => '', // å¯ç»‘å®šç‹¬ç«‹åŸŸå
                'prefix' => '', // URLå‰ç¼€ï¼Œé»˜è®¤è¯­è¨€å¯ä¸ºç©º
                'charset' => 'UTF-8',
                'date_format' => 'Y-m-d',
                'time_format' => 'H:i:s',
                'datetime_format' => 'Y-m-d H:i:s',
                'currency' => 'CNY',
                'currency_symbol' => 'Â¥'
            ],
            'en' => [
                'name' => 'English',
                'native_name' => 'English',
                'locale' => 'en-US',
                'flag' => 'us',
                'direction' => 'ltr',
                'default' => false,
                'enabled' => true,
                'domain' => '',
                'prefix' => 'en',
                'charset' => 'UTF-8',
                'date_format' => 'm/d/Y',
                'time_format' => 'h:i A',
                'datetime_format' => 'm/d/Y h:i A',
                'currency' => 'USD',
                'currency_symbol' => '$'
            ],
            'zh-tw' => [
                'name' => 'ç¹é«”ä¸­æ–‡',
                'native_name' => 'ç¹é«”ä¸­æ–‡',
                'locale' => 'zh-TW',
                'flag' => 'tw',
                'direction' => 'ltr',
                'default' => false,
                'enabled' => false,
                'domain' => '',
                'prefix' => 'tw',
                'charset' => 'UTF-8',
                'date_format' => 'Y-m-d',
                'time_format' => 'H:i:s',
                'datetime_format' => 'Y-m-d H:i:s',
                'currency' => 'TWD',
                'currency_symbol' => 'NT$'
            ],
            'ja' => [
                'name' => 'æ—¥æœ¬èª',
                'native_name' => 'æ—¥æœ¬èª',
                'locale' => 'ja-JP',
                'flag' => 'jp',
                'direction' => 'ltr',
                'default' => false,
                'enabled' => false,
                'domain' => '',
                'prefix' => 'ja',
                'charset' => 'UTF-8',
                'date_format' => 'Yå¹´mæœˆdæ—¥',
                'time_format' => 'H:i',
                'datetime_format' => 'Yå¹´mæœˆdæ—¥ H:i',
                'currency' => 'JPY',
                'currency_symbol' => 'Â¥'
            ],
            'ko' => [
                'name' => 'í•œêµ­ì–´',
                'native_name' => 'í•œêµ­ì–´',
                'locale' => 'ko-KR',
                'flag' => 'kr',
                'direction' => 'ltr',
                'default' => false,
                'enabled' => false,
                'domain' => '',
                'prefix' => 'ko',
                'charset' => 'UTF-8',
                'date_format' => 'Yë…„ mì›” dì¼',
                'time_format' => 'H:i',
                'datetime_format' => 'Yë…„ mì›” dì¼ H:i',
                'currency' => 'KRW',
                'currency_symbol' => 'â‚©'
            ]
        ];
    }
    
    /**
     * è·å–å¯ç”¨çš„è¯­è¨€
     */
    public static function getEnabledLanguages()
    {
        $languages = self::getLanguageConfig();
        return array_filter($languages, function($lang) {
            return $lang['enabled'];
        });
    }
    
    /**
     * è·å–é»˜è®¤è¯­è¨€
     */
    public static function getDefaultLanguage()
    {
        $languages = self::getLanguageConfig();
        foreach ($languages as $code => $config) {
            if ($config['default']) {
                return $code;
            }
        }
        return 'zh-cn';
    }
}
```

### è¯­è¨€æ£€æµ‹ä¸åˆ‡æ¢
```php
/**
 * å¤šè¯­è¨€å¤„ç†å™¨
 */
class LanguageHandler
{
    private static $currentLang = null;
    private static $fallbackLang = 'zh-cn';
    
    /**
     * åˆå§‹åŒ–è¯­è¨€è®¾ç½®
     */
    public static function initialize()
    {
        // è¯­è¨€æ£€æµ‹ä¼˜å…ˆçº§ï¼šURLå‚æ•° > Cookie > æµè§ˆå™¨ > é»˜è®¤
        $lang = self::detectLanguage();
        self::setCurrentLanguage($lang);
        
        // è®¾ç½®ThinkPHPè¯­è¨€
        \think\Lang::set(self::loadLanguagePack($lang));
    }
    
    /**
     * æ£€æµ‹å½“å‰è¯­è¨€
     */
    public static function detectLanguage()
    {
        $enabledLangs = array_keys(MultiLanguageConfig::getEnabledLanguages());
        
        // 1. URLå‚æ•°æ£€æµ‹
        $urlLang = request()->param('lang');
        if ($urlLang && in_array($urlLang, $enabledLangs)) {
            return $urlLang;
        }
        
        // 2. URLè·¯å¾„æ£€æµ‹
        $pathInfo = request()->pathinfo();
        $segments = explode('/', trim($pathInfo, '/'));
        if (!empty($segments[0]) && in_array($segments[0], $enabledLangs)) {
            return $segments[0];
        }
        
        // 3. Cookieæ£€æµ‹
        $cookieLang = cookie('language');
        if ($cookieLang && in_array($cookieLang, $enabledLangs)) {
            return $cookieLang;
        }
        
        // 4. æµè§ˆå™¨è¯­è¨€æ£€æµ‹
        $browserLang = self::detectBrowserLanguage();
        if ($browserLang && in_array($browserLang, $enabledLangs)) {
            return $browserLang;
        }
        
        // 5. é»˜è®¤è¯­è¨€
        return MultiLanguageConfig::getDefaultLanguage();
    }
    
    /**
     * æ£€æµ‹æµè§ˆå™¨è¯­è¨€
     */
    private static function detectBrowserLanguage()
    {
        $acceptLang = request()->header('Accept-Language');
        if (!$acceptLang) {
            return null;
        }
        
        // è§£æAccept-Languageå¤´
        $languages = [];
        preg_match_all('/([a-z]{1,8}(?:-[a-z]{1,8})?)\s*(?:;\s*q\s*=\s*(1|0\.[0-9]+))?/i', $acceptLang, $matches);
        
        if ($matches[1]) {
            foreach ($matches[1] as $i => $lang) {
                $quality = isset($matches[2][$i]) ? (float)$matches[2][$i] : 1.0;
                $languages[strtolower($lang)] = $quality;
            }
            arsort($languages);
            
            // åŒ¹é…æ”¯æŒçš„è¯­è¨€
            $langMap = [
                'zh-cn' => ['zh-cn', 'zh', 'zh-hans'],
                'en' => ['en', 'en-us', 'en-gb'],
                'zh-tw' => ['zh-tw', 'zh-hant'],
                'ja' => ['ja', 'ja-jp'],
                'ko' => ['ko', 'ko-kr']
            ];
            
            foreach ($languages as $browserLang => $quality) {
                foreach ($langMap as $supportedLang => $patterns) {
                    if (in_array($browserLang, $patterns)) {
                        return $supportedLang;
                    }
                }
            }
        }
        
        return null;
    }
    
    /**
     * è®¾ç½®å½“å‰è¯­è¨€
     */
    public static function setCurrentLanguage($lang)
    {
        $enabledLangs = array_keys(MultiLanguageConfig::getEnabledLanguages());
        if (!in_array($lang, $enabledLangs)) {
            $lang = MultiLanguageConfig::getDefaultLanguage();
        }
        
        self::$currentLang = $lang;
        
        // è®¾ç½®Cookie
        cookie('language', $lang, 86400 * 30); // 30å¤©
        
        // è®¾ç½®å…¨å±€å˜é‡
        config('app.default_lang', $lang);
        
        return $lang;
    }
    
    /**
     * è·å–å½“å‰è¯­è¨€
     */
    public static function getCurrentLanguage()
    {
        return self::$currentLang ?: MultiLanguageConfig::getDefaultLanguage();
    }
    
    /**
     * åŠ è½½è¯­è¨€åŒ…
     */
    public static function loadLanguagePack($lang)
    {
        $langFile = ADDON_PATH . 'ldcms/lang/' . $lang . '.php';
        
        if (file_exists($langFile)) {
            return include $langFile;
        }
        
        // åŠ è½½é»˜è®¤è¯­è¨€åŒ…
        $defaultLangFile = ADDON_PATH . 'ldcms/lang/' . self::$fallbackLang . '.php';
        if (file_exists($defaultLangFile)) {
            return include $defaultLangFile;
        }
        
        return [];
    }
    
    /**
     * ç¿»è¯‘æ–‡æœ¬
     */
    public static function translate($key, $params = [], $lang = null)
    {
        $lang = $lang ?: self::getCurrentLanguage();
        $langPack = self::loadLanguagePack($lang);
        
        $text = isset($langPack[$key]) ? $langPack[$key] : $key;
        
        // å‚æ•°æ›¿æ¢
        if (!empty($params)) {
            foreach ($params as $param => $value) {
                $text = str_replace(':' . $param, $value, $text);
            }
        }
        
        return $text;
    }
    
    /**
     * ç”Ÿæˆå¤šè¯­è¨€URL
     */
    public static function generateUrl($route, $params = [], $lang = null)
    {
        $lang = $lang ?: self::getCurrentLanguage();
        $langConfig = MultiLanguageConfig::getLanguageConfig()[$lang];
        
        // åŸŸåç»‘å®š
        if (!empty($langConfig['domain'])) {
            $domain = $langConfig['domain'];
        } else {
            $domain = request()->domain();
        }
        
        // URLå‰ç¼€
        $prefix = $langConfig['prefix'] ? '/' . $langConfig['prefix'] : '';
        
        // ç”ŸæˆURL
        $url = $domain . $prefix . '/' . ltrim($route, '/');
        
        // æ·»åŠ å‚æ•°
        if (!empty($params)) {
            $url .= '?' . http_build_query($params);
        }
        
        return $url;
    }
}
```

---

## ğŸ—ƒï¸ æ•°æ®åº“å¤šè¯­è¨€è®¾è®¡

### å¤šè¯­è¨€è¡¨è®¾è®¡è§„èŒƒ
```sql
-- æ–¹æ¡ˆä¸€ï¼šå•è¡¨å¤šå­—æ®µï¼ˆé€‚ç”¨äºå­—æ®µè¾ƒå°‘çš„æƒ…å†µï¼‰
CREATE TABLE `fa_category` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `name_zh_cn` varchar(255) DEFAULT '' COMMENT 'ä¸­æ–‡åç§°',
    `name_en` varchar(255) DEFAULT '' COMMENT 'è‹±æ–‡åç§°',
    `name_zh_tw` varchar(255) DEFAULT '' COMMENT 'ç¹ä½“ä¸­æ–‡åç§°',
    `description_zh_cn` text COMMENT 'ä¸­æ–‡æè¿°',
    `description_en` text COMMENT 'è‹±æ–‡æè¿°',
    `description_zh_tw` text COMMENT 'ç¹ä½“ä¸­æ–‡æè¿°',
    `sort` int(10) DEFAULT '99',
    `status` tinyint(1) DEFAULT '1',
    `create_time` bigint(20) DEFAULT NULL,
    `update_time` bigint(20) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åˆ†ç±»è¡¨ï¼ˆå¤šå­—æ®µæ–¹æ¡ˆï¼‰';

-- æ–¹æ¡ˆäºŒï¼šåˆ†è¡¨å­˜å‚¨ï¼ˆæ¨èæ–¹æ¡ˆï¼‰
CREATE TABLE `fa_category` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `sort` int(10) DEFAULT '99',
    `status` tinyint(1) DEFAULT '1',
    `create_time` bigint(20) DEFAULT NULL,
    `update_time` bigint(20) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åˆ†ç±»ä¸»è¡¨';

CREATE TABLE `fa_category_lang` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `category_id` int(11) NOT NULL COMMENT 'åˆ†ç±»ID',
    `lang` varchar(10) NOT NULL DEFAULT 'zh-cn' COMMENT 'è¯­è¨€ä»£ç ',
    `name` varchar(255) DEFAULT '' COMMENT 'åç§°',
    `description` text COMMENT 'æè¿°',
    `seo_title` varchar(255) DEFAULT '' COMMENT 'SEOæ ‡é¢˜',
    `seo_keywords` varchar(255) DEFAULT '' COMMENT 'SEOå…³é”®è¯',
    `seo_description` varchar(255) DEFAULT '' COMMENT 'SEOæè¿°',
    `create_time` bigint(20) DEFAULT NULL,
    `update_time` bigint(20) DEFAULT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `category_lang` (`category_id`, `lang`),
    KEY `lang` (`lang`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åˆ†ç±»è¯­è¨€è¡¨';

-- æ–¹æ¡ˆä¸‰ï¼šJSONå­—æ®µå­˜å‚¨ï¼ˆMySQL 5.7+ï¼‰
CREATE TABLE `fa_category_json` (
    `id` int(11) NOT NULL AUTO_INCREMENT,
    `multilang_data` json COMMENT 'å¤šè¯­è¨€æ•°æ®',
    `sort` int(10) DEFAULT '99',
    `status` tinyint(1) DEFAULT '1',
    `create_time` bigint(20) DEFAULT NULL,
    `update_time` bigint(20) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='åˆ†ç±»è¡¨ï¼ˆJSONæ–¹æ¡ˆï¼‰';

-- JSONæ•°æ®ç»“æ„ç¤ºä¾‹ï¼š
-- {
--     "zh-cn": {"name": "äº§å“ä¸­å¿ƒ", "description": "äº§å“ä»‹ç»"},
--     "en": {"name": "Products", "description": "Product Introduction"},
--     "zh-tw": {"name": "ç”¢å“ä¸­å¿ƒ", "description": "ç”¢å“ä»‹ç´¹"}
-- }
```

### å¤šè¯­è¨€æ¨¡å‹åŸºç±»
```php
/**
 * å¤šè¯­è¨€æ¨¡å‹åŸºç±»
 */
abstract class MultiLanguageModel extends \think\Model
{
    // å¤šè¯­è¨€å­—æ®µæ˜ å°„
    protected $langFields = [];
    
    // å½“å‰è¯­è¨€
    protected $currentLang = null;
    
    /**
     * åˆå§‹åŒ–
     */
    protected function initialize()
    {
        parent::initialize();
        $this->currentLang = LanguageHandler::getCurrentLanguage();
    }
    
    /**
     * è·å–å¤šè¯­è¨€å­—æ®µ
     */
    public function getLangFieldAttr($value, $data)
    {
        // æ–¹æ¡ˆä¸€ï¼šå¤šå­—æ®µæ–¹æ¡ˆ
        if ($this->isMultiFieldMode()) {
            $fieldName = debug_backtrace()[1]['function'];
            $fieldName = substr($fieldName, 3, -4); // ç§»é™¤getå’ŒAttr
            $langFieldName = strtolower($fieldName) . '_' . str_replace('-', '_', $this->currentLang);
            
            return isset($data[$langFieldName]) ? $data[$langFieldName] : '';
        }
        
        // æ–¹æ¡ˆäºŒï¼šå…³è”è¡¨æ–¹æ¡ˆ
        if ($this->isRelationMode()) {
            return $this->getLangData($fieldName);
        }
        
        // æ–¹æ¡ˆä¸‰ï¼šJSONå­—æ®µæ–¹æ¡ˆ
        if ($this->isJsonMode()) {
            $multilangData = json_decode($data['multilang_data'] ?? '{}', true);
            return $multilangData[$this->currentLang][$fieldName] ?? '';
        }
        
        return $value;
    }
    
    /**
     * è®¾ç½®å¤šè¯­è¨€å­—æ®µ
     */
    public function setLangFieldAttr($value, $field)
    {
        // æ ¹æ®ä¸åŒæ–¹æ¡ˆå¤„ç†å­—æ®µè®¾ç½®
        if ($this->isMultiFieldMode()) {
            $langFieldName = $field . '_' . str_replace('-', '_', $this->currentLang);
            return $value;
        }
        
        return $value;
    }
    
    /**
     * è·å–å…³è”è¯­è¨€æ•°æ®
     */
    protected function getLangData($field = null)
    {
        $langTableName = $this->name . '_lang';
        $langData = \think\Db::name($langTableName)
                           ->where($this->name . '_id', $this->id)
                           ->where('lang', $this->currentLang)
                           ->find();
        
        return $field ? ($langData[$field] ?? '') : $langData;
    }
    
    /**
     * ä¿å­˜å¤šè¯­è¨€æ•°æ®
     */
    public function saveLangData($langData, $lang = null)
    {
        $lang = $lang ?: $this->currentLang;
        $langTableName = $this->name . '_lang';
        
        $existingData = \think\Db::name($langTableName)
                               ->where($this->name . '_id', $this->id)
                               ->where('lang', $lang)
                               ->find();
        
        $data = array_merge($langData, [
            $this->name . '_id' => $this->id,
            'lang' => $lang,
            'update_time' => time()
        ]);
        
        if ($existingData) {
            return \think\Db::name($langTableName)
                           ->where('id', $existingData['id'])
                           ->update($data);
        } else {
            $data['create_time'] = time();
            return \think\Db::name($langTableName)->insert($data);
        }
    }
    
    /**
     * è·å–æ‰€æœ‰è¯­è¨€æ•°æ®
     */
    public function getAllLangData()
    {
        $langTableName = $this->name . '_lang';
        $langDataList = \think\Db::name($langTableName)
                               ->where($this->name . '_id', $this->id)
                               ->select();
        
        $result = [];
        foreach ($langDataList as $langData) {
            $result[$langData['lang']] = $langData;
        }
        
        return $result;
    }
    
    /**
     * å¤åˆ¶è¯­è¨€æ•°æ®
     */
    public function copyLangData($fromLang, $toLang, $fields = [])
    {
        $langTableName = $this->name . '_lang';
        
        // è·å–æºè¯­è¨€æ•°æ®
        $sourceData = \think\Db::name($langTableName)
                             ->where($this->name . '_id', $this->id)
                             ->where('lang', $fromLang)
                             ->find();
        
        if (!$sourceData) {
            return false;
        }
        
        // å‡†å¤‡ç›®æ ‡è¯­è¨€æ•°æ®
        $targetData = $sourceData;
        unset($targetData['id']);
        $targetData['lang'] = $toLang;
        $targetData['create_time'] = time();
        $targetData['update_time'] = time();
        
        // å¦‚æœæŒ‡å®šäº†ç‰¹å®šå­—æ®µï¼Œåªå¤åˆ¶è¿™äº›å­—æ®µ
        if (!empty($fields)) {
            $newTargetData = [
                $this->name . '_id' => $this->id,
                'lang' => $toLang,
                'create_time' => time(),
                'update_time' => time()
            ];
            
            foreach ($fields as $field) {
                if (isset($sourceData[$field])) {
                    $newTargetData[$field] = $sourceData[$field];
                }
            }
            
            $targetData = $newTargetData;
        }
        
        // æ£€æŸ¥ç›®æ ‡è¯­è¨€æ•°æ®æ˜¯å¦å·²å­˜åœ¨
        $existingData = \think\Db::name($langTableName)
                               ->where($this->name . '_id', $this->id)
                               ->where('lang', $toLang)
                               ->find();
        
        if ($existingData) {
            return \think\Db::name($langTableName)
                           ->where('id', $existingData['id'])
                           ->update($targetData);
        } else {
            return \think\Db::name($langTableName)->insert($targetData);
        }
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå¤šå­—æ®µæ¨¡å¼
     */
    protected function isMultiFieldMode()
    {
        return isset($this->langMode) && $this->langMode === 'multifield';
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºå…³è”è¡¨æ¨¡å¼
     */
    protected function isRelationMode()
    {
        return !isset($this->langMode) || $this->langMode === 'relation';
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦ä¸ºJSONæ¨¡å¼
     */
    protected function isJsonMode()
    {
        return isset($this->langMode) && $this->langMode === 'json';
    }
}
```

---

## ğŸ¨ æ¨¡æ¿å¤šè¯­è¨€å¤„ç†

### æ¨¡æ¿å¤šè¯­è¨€æ ‡ç­¾
```html
<!-- å¤šè¯­è¨€æ–‡æœ¬è¾“å‡º -->
{:lang('hello')}                    <!-- è¾“å‡ºï¼šä½ å¥½ / Hello -->
{:lang('welcome', ['name' => $user.name])}  <!-- å‚æ•°æ›¿æ¢ -->

<!-- æ¡ä»¶è¯­è¨€æ˜¾ç¤º -->
{if condition="$Think.lang eq 'zh-cn'"}
    <div class="chinese-content">ä¸­æ–‡å†…å®¹</div>
{elseif condition="$Think.lang eq 'en'"}
    <div class="english-content">English Content</div>
{/if}

<!-- å¤šè¯­è¨€é“¾æ¥ -->
<a href="{:multilang_url('index/about')}">{:lang('about_us')}</a>
<a href="{:multilang_url('index/contact', [], 'en')}">{:lang('contact_us')}</a>

<!-- è¯­è¨€åˆ‡æ¢å™¨ -->
<div class="language-switcher">
    {volist name=":get_enabled_languages()" id="lang_info" key="lang_code"}
    <a href="{:multilang_url($Think.request.pathinfo, [], $lang_code)}" 
       class="{eq name='lang_code' value='$Think.lang'}active{/eq}">
        <img src="/static/flags/{$lang_info.flag}.png" alt="{$lang_info.name}">
        {$lang_info.native_name}
    </a>
    {/volist}
</div>

<!-- å¤šè¯­è¨€è¡¨å• -->
<form class="multilang-form">
    {volist name=":get_enabled_languages()" id="lang_info" key="lang_code"}
    <div class="lang-tab {eq name='lang_code' value='zh-cn'}active{/eq}" data-lang="{$lang_code}">
        <h4>{$lang_info.native_name}</h4>
        
        <div class="form-group">
            <label>{:lang('title')}:</label>
            <input type="text" name="title[{$lang_code}]" value="{$data.title[$lang_code]|default=''}" required>
        </div>
        
        <div class="form-group">
            <label>{:lang('content')}:</label>
            <textarea name="content[{$lang_code}]" class="editor">{$data.content[$lang_code]|default=''}</textarea>
        </div>
    </div>
    {/volist}
</form>
```

### æ¨¡æ¿å‡½æ•°æ‰©å±•
```php
/**
 * å¤šè¯­è¨€æ¨¡æ¿å‡½æ•°
 */

/**
 * å¤šè¯­è¨€æ–‡æœ¬ç¿»è¯‘
 */
function lang($key, $params = [])
{
    return LanguageHandler::translate($key, $params);
}

/**
 * ç”Ÿæˆå¤šè¯­è¨€URL
 */
function multilang_url($route, $params = [], $lang = null)
{
    return LanguageHandler::generateUrl($route, $params, $lang);
}

/**
 * è·å–å¯ç”¨çš„è¯­è¨€åˆ—è¡¨
 */
function get_enabled_languages()
{
    return MultiLanguageConfig::getEnabledLanguages();
}

/**
 * è·å–å½“å‰è¯­è¨€é…ç½®
 */
function get_current_language_config()
{
    $currentLang = LanguageHandler::getCurrentLanguage();
    $languages = MultiLanguageConfig::getLanguageConfig();
    return $languages[$currentLang] ?? [];
}

/**
 * æ ¼å¼åŒ–å¤šè¯­è¨€æ—¥æœŸ
 */
function format_multilang_date($timestamp, $format = null)
{
    $langConfig = get_current_language_config();
    $format = $format ?: $langConfig['datetime_format'];
    
    return date($format, $timestamp);
}

/**
 * æ ¼å¼åŒ–å¤šè¯­è¨€è´§å¸
 */
function format_multilang_currency($amount, $showSymbol = true)
{
    $langConfig = get_current_language_config();
    $symbol = $showSymbol ? $langConfig['currency_symbol'] : '';
    
    return $symbol . number_format($amount, 2);
}

/**
 * è·å–å¤šè¯­è¨€å­—æ®µå€¼
 */
function get_multilang_field($data, $field, $lang = null)
{
    $lang = $lang ?: LanguageHandler::getCurrentLanguage();
    
    // JSONæ ¼å¼æ•°æ®
    if (is_string($data) && json_decode($data, true)) {
        $multilangData = json_decode($data, true);
        return $multilangData[$lang][$field] ?? '';
    }
    
    // æ•°ç»„æ ¼å¼æ•°æ®
    if (is_array($data)) {
        return $data[$lang][$field] ?? $data[$field][$lang] ?? '';
    }
    
    return '';
}
```

---

## ğŸ”§ URLå¤šè¯­è¨€å¤„ç†

### URLè·¯ç”±è§„åˆ™
```php
/**
 * å¤šè¯­è¨€è·¯ç”±é…ç½®
 */
class MultiLanguageRoute
{
    /**
     * æ³¨å†Œå¤šè¯­è¨€è·¯ç”±
     */
    public static function registerRoutes()
    {
        $languages = MultiLanguageConfig::getEnabledLanguages();
        
        foreach ($languages as $langCode => $langConfig) {
            if (empty($langConfig['prefix'])) {
                // é»˜è®¤è¯­è¨€ä¸éœ€è¦å‰ç¼€
                self::registerDefaultLanguageRoutes();
            } else {
                // å…¶ä»–è¯­è¨€éœ€è¦å‰ç¼€
                self::registerPrefixLanguageRoutes($langCode, $langConfig['prefix']);
            }
        }
    }
    
    /**
     * æ³¨å†Œé»˜è®¤è¯­è¨€è·¯ç”±
     */
    private static function registerDefaultLanguageRoutes()
    {
        // é¦–é¡µè·¯ç”±
        \think\Route::get('/', 'addons/ldcms/Index/index');
        
        // åˆ†ç±»åˆ—è¡¨è·¯ç”±
        \think\Route::get('category/<id:\d+>', 'addons/ldcms/Lists/index');
        \think\Route::get('category/<urlname>', 'addons/ldcms/Lists/index');
        
        // æ–‡æ¡£è¯¦æƒ…è·¯ç”±
        \think\Route::get('detail/<id:\d+>', 'addons/ldcms/Detail/index');
        \think\Route::get('detail/<id:\d+>.html', 'addons/ldcms/Detail/index');
        
        // æœç´¢è·¯ç”±
        \think\Route::get('search', 'addons/ldcms/Search/index');
        
        // è‡ªå®šä¹‰è¡¨å•è·¯ç”±
        \think\Route::get('form/<id:\d+>', 'addons/ldcms/Diyform/index');
        \think\Route::post('form/<id:\d+>', 'addons/ldcms/Diyform/submit');
    }
    
    /**
     * æ³¨å†Œå¸¦å‰ç¼€çš„è¯­è¨€è·¯ç”±
     */
    private static function registerPrefixLanguageRoutes($langCode, $prefix)
    {
        // è·¯ç”±ç»„
        \think\Route::group($prefix, function() use ($langCode) {
            // è®¾ç½®å½“å‰è¯­è¨€
            \think\Route::pattern([
                'lang' => $langCode
            ]);
            
            // é¦–é¡µè·¯ç”±
            \think\Route::get('/', 'addons/ldcms/Index/index')
                       ->append(['lang' => $langCode]);
            
            // åˆ†ç±»åˆ—è¡¨è·¯ç”±
            \think\Route::get('category/<id:\d+>', 'addons/ldcms/Lists/index')
                       ->append(['lang' => $langCode]);
            \think\Route::get('category/<urlname>', 'addons/ldcms/Lists/index')
                       ->append(['lang' => $langCode]);
            
            // æ–‡æ¡£è¯¦æƒ…è·¯ç”±
            \think\Route::get('detail/<id:\d+>', 'addons/ldcms/Detail/index')
                       ->append(['lang' => $langCode]);
            \think\Route::get('detail/<id:\d+>.html', 'addons/ldcms/Detail/index')
                       ->append(['lang' => $langCode]);
            
            // æœç´¢è·¯ç”±
            \think\Route::get('search', 'addons/ldcms/Search/index')
                       ->append(['lang' => $langCode]);
        });
    }
    
    /**
     * URLç”Ÿæˆè§„åˆ™
     */
    public static function buildUrl($route, $params = [], $lang = null)
    {
        $lang = $lang ?: LanguageHandler::getCurrentLanguage();
        $langConfig = MultiLanguageConfig::getLanguageConfig()[$lang];
        
        // åŸŸåå¤„ç†
        $domain = !empty($langConfig['domain']) ? $langConfig['domain'] : request()->domain();
        
        // å‰ç¼€å¤„ç†
        $prefix = !empty($langConfig['prefix']) ? '/' . $langConfig['prefix'] : '';
        
        // æ„å»ºURL
        $url = $domain . $prefix . '/' . ltrim($route, '/');
        
        // æ·»åŠ å‚æ•°
        if (!empty($params)) {
            $url .= (strpos($url, '?') !== false ? '&' : '?') . http_build_query($params);
        }
        
        return $url;
    }
}
```

### SEOå‹å¥½URL
```php
/**
 * SEOå‹å¥½çš„å¤šè¯­è¨€URLç”Ÿæˆå™¨
 */
class SEOFriendlyURL
{
    /**
     * ç”Ÿæˆåˆ†ç±»URL
     */
    public static function categoryUrl($category, $lang = null)
    {
        $lang = $lang ?: LanguageHandler::getCurrentLanguage();
        
        // è·å–åˆ†ç±»çš„å¤šè¯­è¨€æ•°æ®
        $categoryLangData = self::getCategoryLangData($category['id'], $lang);
        
        // ä½¿ç”¨SEOå‹å¥½çš„URLåç§°
        $urlName = $categoryLangData['urlname'] ?? $category['urlname'] ?? 'category-' . $category['id'];
        
        return MultiLanguageRoute::buildUrl('category/' . $urlName, [], $lang);
    }
    
    /**
     * ç”Ÿæˆæ–‡æ¡£URL
     */
    public static function documentUrl($document, $lang = null)
    {
        $lang = $lang ?: LanguageHandler::getCurrentLanguage();
        
        // è·å–æ–‡æ¡£çš„å¤šè¯­è¨€æ•°æ®
        $documentLangData = self::getDocumentLangData($document['id'], $lang);
        
        // ç”ŸæˆSEOå‹å¥½çš„URL
        $urlName = $documentLangData['urlname'] ?? self::generateUrlName($documentLangData['title'] ?? $document['title']);
        
        return MultiLanguageRoute::buildUrl('detail/' . $document['id'] . '-' . $urlName . '.html', [], $lang);
    }
    
    /**
     * ç”ŸæˆURLåç§°
     */
    private static function generateUrlName($title)
    {
        // ä¸­æ–‡è½¬æ‹¼éŸ³
        if (preg_match('/[\x{4e00}-\x{9fff}]+/u', $title)) {
            $urlName = \overtrue\Pinyin\Pinyin::slug($title);
        } else {
            // è‹±æ–‡å¤„ç†
            $urlName = strtolower(trim(preg_replace('/[^A-Za-z0-9-]+/', '-', $title), '-'));
        }
        
        return substr($urlName, 0, 100); // é™åˆ¶é•¿åº¦
    }
    
    /**
     * è·å–åˆ†ç±»è¯­è¨€æ•°æ®
     */
    private static function getCategoryLangData($categoryId, $lang)
    {
        return \think\Db::name('ldcms_category_lang')
                       ->where('category_id', $categoryId)
                       ->where('lang', $lang)
                       ->find() ?: [];
    }
    
    /**
     * è·å–æ–‡æ¡£è¯­è¨€æ•°æ®
     */
    private static function getDocumentLangData($documentId, $lang)
    {
        return \think\Db::name('ldcms_document_lang')
                       ->where('document_id', $documentId)
                       ->where('lang', $lang)
                       ->find() ?: [];
    }
}
```

---

## ğŸ“ å†…å®¹ç¿»è¯‘ç®¡ç†

### ç¿»è¯‘å·¥ä½œæµ
```php
/**
 * ç¿»è¯‘ç®¡ç†å™¨
 */
class TranslationManager
{
    /**
     * åˆ›å»ºç¿»è¯‘ä»»åŠ¡
     */
    public static function createTranslationTask($sourceId, $sourceType, $sourceLang, $targetLangs, $fields = [])
    {
        $taskId = \think\Db::name('translation_tasks')->insertGetId([
            'source_id' => $sourceId,
            'source_type' => $sourceType,
            'source_lang' => $sourceLang,
            'target_langs' => json_encode($targetLangs),
            'fields' => json_encode($fields),
            'status' => 'pending',
            'create_time' => time(),
            'update_time' => time()
        ]);
        
        // åˆ›å»ºå…·ä½“çš„ç¿»è¯‘é¡¹ç›®
        foreach ($targetLangs as $targetLang) {
            foreach ($fields as $field) {
                \think\Db::name('translation_items')->insert([
                    'task_id' => $taskId,
                    'source_lang' => $sourceLang,
                    'target_lang' => $targetLang,
                    'field_name' => $field,
                    'source_text' => self::getSourceText($sourceId, $sourceType, $field, $sourceLang),
                    'translated_text' => '',
                    'status' => 'pending',
                    'create_time' => time(),
                    'update_time' => time()
                ]);
            }
        }
        
        return $taskId;
    }
    
    /**
     * è‡ªåŠ¨ç¿»è¯‘ï¼ˆè°ƒç”¨ç¿»è¯‘APIï¼‰
     */
    public static function autoTranslate($taskId, $provider = 'google')
    {
        $items = \think\Db::name('translation_items')
                         ->where('task_id', $taskId)
                         ->where('status', 'pending')
                         ->select();
        
        foreach ($items as $item) {
            try {
                $translatedText = self::callTranslationAPI(
                    $item['source_text'],
                    $item['source_lang'],
                    $item['target_lang'],
                    $provider
                );
                
                \think\Db::name('translation_items')
                        ->where('id', $item['id'])
                        ->update([
                            'translated_text' => $translatedText,
                            'status' => 'translated',
                            'update_time' => time()
                        ]);
                        
            } catch (\Exception $e) {
                \think\Db::name('translation_items')
                        ->where('id', $item['id'])
                        ->update([
                            'status' => 'failed',
                            'error_message' => $e->getMessage(),
                            'update_time' => time()
                        ]);
            }
        }
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        self::updateTaskStatus($taskId);
    }
    
    /**
     * äººå·¥ç¿»è¯‘æäº¤
     */
    public static function submitManualTranslation($itemId, $translatedText, $translatorId)
    {
        \think\Db::name('translation_items')
                ->where('id', $itemId)
                ->update([
                    'translated_text' => $translatedText,
                    'status' => 'translated',
                    'translator_id' => $translatorId,
                    'update_time' => time()
                ]);
        
        // æ›´æ–°ä»»åŠ¡çŠ¶æ€
        $item = \think\Db::name('translation_items')->find($itemId);
        self::updateTaskStatus($item['task_id']);
    }
    
    /**
     * åº”ç”¨ç¿»è¯‘ç»“æœ
     */
    public static function applyTranslations($taskId)
    {
        $task = \think\Db::name('translation_tasks')->find($taskId);
        if (!$task || $task['status'] !== 'completed') {
            throw new \Exception('ç¿»è¯‘ä»»åŠ¡æœªå®Œæˆ');
        }
        
        $items = \think\Db::name('translation_items')
                         ->where('task_id', $taskId)
                         ->where('status', 'translated')
                         ->select();
        
        foreach ($items as $item) {
            self::saveTranslatedContent(
                $task['source_id'],
                $task['source_type'],
                $item['field_name'],
                $item['target_lang'],
                $item['translated_text']
            );
        }
        
        // æ ‡è®°ä»»åŠ¡ä¸ºå·²åº”ç”¨
        \think\Db::name('translation_tasks')
                ->where('id', $taskId)
                ->update([
                    'status' => 'applied',
                    'update_time' => time()
                ]);
    }
    
    /**
     * è°ƒç”¨ç¿»è¯‘API
     */
    private static function callTranslationAPI($text, $sourceLang, $targetLang, $provider)
    {
        switch ($provider) {
            case 'google':
                return self::googleTranslate($text, $sourceLang, $targetLang);
            case 'baidu':
                return self::baiduTranslate($text, $sourceLang, $targetLang);
            case 'tencent':
                return self::tencentTranslate($text, $sourceLang, $targetLang);
            default:
                throw new \Exception('ä¸æ”¯æŒçš„ç¿»è¯‘æœåŠ¡æä¾›å•†');
        }
    }
    
    /**
     * Googleç¿»è¯‘API
     */
    private static function googleTranslate($text, $sourceLang, $targetLang)
    {
        $config = config('translation.google');
        $apiKey = $config['api_key'];
        
        $url = 'https://translation.googleapis.com/language/translate/v2';
        $params = [
            'key' => $apiKey,
            'q' => $text,
            'source' => self::convertLangCode($sourceLang, 'google'),
            'target' => self::convertLangCode($targetLang, 'google'),
            'format' => 'text'
        ];
        
        $response = self::httpPost($url, $params);
        $result = json_decode($response, true);
        
        if (isset($result['data']['translations'][0]['translatedText'])) {
            return $result['data']['translations'][0]['translatedText'];
        }
        
        throw new \Exception('Googleç¿»è¯‘APIè°ƒç”¨å¤±è´¥');
    }
    
    /**
     * ç™¾åº¦ç¿»è¯‘API
     */
    private static function baiduTranslate($text, $sourceLang, $targetLang)
    {
        $config = config('translation.baidu');
        $appId = $config['app_id'];
        $secretKey = $config['secret_key'];
        
        $salt = time();
        $sign = md5($appId . $text . $salt . $secretKey);
        
        $url = 'https://fanyi-api.baidu.com/api/trans/vip/translate';
        $params = [
            'q' => $text,
            'from' => self::convertLangCode($sourceLang, 'baidu'),
            'to' => self::convertLangCode($targetLang, 'baidu'),
            'appid' => $appId,
            'salt' => $salt,
            'sign' => $sign
        ];
        
        $response = self::httpPost($url, $params);
        $result = json_decode($response, true);
        
        if (isset($result['trans_result'][0]['dst'])) {
            return $result['trans_result'][0]['dst'];
        }
        
        throw new \Exception('ç™¾åº¦ç¿»è¯‘APIè°ƒç”¨å¤±è´¥');
    }
    
    /**
     * è¯­è¨€ä»£ç è½¬æ¢
     */
    private static function convertLangCode($langCode, $provider)
    {
        $langMap = [
            'google' => [
                'zh-cn' => 'zh-CN',
                'zh-tw' => 'zh-TW',
                'en' => 'en',
                'ja' => 'ja',
                'ko' => 'ko'
            ],
            'baidu' => [
                'zh-cn' => 'zh',
                'zh-tw' => 'cht',
                'en' => 'en',
                'ja' => 'jp',
                'ko' => 'kor'
            ]
        ];
        
        return $langMap[$provider][$langCode] ?? $langCode;
    }
    
    /**
     * HTTP POSTè¯·æ±‚
     */
    private static function httpPost($url, $params)
    {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($params));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        
        $response = curl_exec($ch);
        
        if (curl_error($ch)) {
            throw new \Exception('HTTPè¯·æ±‚å¤±è´¥ï¼š' . curl_error($ch));
        }
        
        curl_close($ch);
        return $response;
    }
}
```

---

## ğŸ“‹ å¤šè¯­è¨€å¼€å‘æ£€æŸ¥æ¸…å•

### åŸºç¡€é…ç½®æ£€æŸ¥
- [ ] è¯­è¨€é…ç½®æ–‡ä»¶å®Œæ•´
- [ ] é»˜è®¤è¯­è¨€è®¾ç½®æ­£ç¡®
- [ ] è¯­è¨€æ£€æµ‹é€»è¾‘æ­£å¸¸
- [ ] Cookieè¯­è¨€å­˜å‚¨
- [ ] æµè§ˆå™¨è¯­è¨€æ£€æµ‹
- [ ] URLè¯­è¨€å‚æ•°å¤„ç†
- [ ] åŸŸåç»‘å®šé…ç½®

### æ•°æ®åº“è®¾è®¡æ£€æŸ¥
- [ ] å¤šè¯­è¨€è¡¨ç»“æ„è®¾è®¡
- [ ] è¯­è¨€å­—æ®µç´¢å¼•ä¼˜åŒ–
- [ ] æ•°æ®å®Œæ•´æ€§çº¦æŸ
- [ ] è¯­è¨€æ•°æ®å…³è”æ­£ç¡®
- [ ] é»˜è®¤è¯­è¨€æ•°æ®å­˜åœ¨
- [ ] æ•°æ®è¿ç§»è„šæœ¬

### æ¨¡æ¿å¤šè¯­è¨€æ£€æŸ¥
- [ ] è¯­è¨€åŒ…æ–‡ä»¶å®Œæ•´
- [ ] æ¨¡æ¿è¯­è¨€æ ‡ç­¾æ­£ç¡®
- [ ] è¯­è¨€åˆ‡æ¢åŠŸèƒ½
- [ ] å¤šè¯­è¨€è¡¨å•å¤„ç†
- [ ] æ—¥æœŸæ—¶é—´æœ¬åœ°åŒ–
- [ ] è´§å¸æ ¼å¼æœ¬åœ°åŒ–
- [ ] æ•°å­—æ ¼å¼æœ¬åœ°åŒ–

### URLå¤šè¯­è¨€æ£€æŸ¥
- [ ] å¤šè¯­è¨€è·¯ç”±è§„åˆ™
- [ ] SEOå‹å¥½URL
- [ ] è¯­è¨€å‰ç¼€å¤„ç†
- [ ] é‡å®šå‘è§„åˆ™
- [ ] Canonicalæ ‡ç­¾
- [ ] Hreflangæ ‡ç­¾
- [ ] ç«™ç‚¹åœ°å›¾å¤šè¯­è¨€

### APIå¤šè¯­è¨€æ£€æŸ¥
- [ ] APIè¯­è¨€å‚æ•°
- [ ] å“åº”æ•°æ®å¤šè¯­è¨€
- [ ] é”™è¯¯ä¿¡æ¯å¤šè¯­è¨€
- [ ] APIæ–‡æ¡£å¤šè¯­è¨€
- [ ] æ¥å£ç‰ˆæœ¬æ§åˆ¶
- [ ] ç¼“å­˜é”®å¤šè¯­è¨€

### SEOä¼˜åŒ–æ£€æŸ¥
- [ ] å¤šè¯­è¨€é¡µé¢æ ‡é¢˜
- [ ] Metaæè¿°å¤šè¯­è¨€
- [ ] Metaå…³é”®è¯å¤šè¯­è¨€
- [ ] ç»“æ„åŒ–æ•°æ®å¤šè¯­è¨€
- [ ] é¢åŒ…å±‘å¯¼èˆªå¤šè¯­è¨€
- [ ] æœç´¢å¼•æ“æäº¤

---

**æ³¨æ„**: å¤šè¯­è¨€å¼€å‘éœ€è¦è€ƒè™‘æ–‡åŒ–å·®å¼‚ã€é˜…è¯»ä¹ æƒ¯ã€æ³•å¾‹æ³•è§„ç­‰å› ç´ ï¼Œä¸ä»…ä»…æ˜¯è¯­è¨€ç¿»è¯‘ã€‚å»ºè®®è˜è¯·ä¸“ä¸šçš„æœ¬åœ°åŒ–å›¢é˜Ÿè¿›è¡Œå†…å®¹å®¡æ ¸ã€‚