---
alwaysApply: true
priority: 1
techStack: "ThinkPHP 5.1"
---

# ThinkPHP 5.1 å¼€å‘æ ‡å‡†è§„èŒƒ

> **æ¡†æ¶ç‰ˆæœ¬**: ThinkPHP 5.1.x
> **é€‚ç”¨åœºæ™¯**: MVCæ¶æ„å¼€å‘ã€RESTful APIã€å‘½ä»¤è¡Œåº”ç”¨

---

## ğŸ—ï¸ ThinkPHPæ¶æ„è§„èŒƒ

### åº”ç”¨ç»“æ„æ ‡å‡†
```
application/
â”œâ”€â”€ common/                # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ controller/       # å…¬å…±æ§åˆ¶å™¨åŸºç±»
â”‚   â”œâ”€â”€ model/           # å…¬å…±æ¨¡å‹
â”‚   â”œâ”€â”€ library/         # å…¬å…±ç±»åº“
â”‚   â”œâ”€â”€ behavior/        # è¡Œä¸ºç±»
â”‚   â””â”€â”€ exception/       # å¼‚å¸¸ç±»
â”œâ”€â”€ [module]/            # å…·ä½“ä¸šåŠ¡æ¨¡å—
â”‚   â”œâ”€â”€ controller/      # æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ model/          # æ¨¡å‹
â”‚   â”œâ”€â”€ view/           # è§†å›¾
â”‚   â”œâ”€â”€ validate/       # éªŒè¯å™¨
â”‚   â”œâ”€â”€ middleware/     # ä¸­é—´ä»¶
â”‚   â””â”€â”€ config/         # æ¨¡å—é…ç½®
â””â”€â”€ command/            # å‘½ä»¤è¡Œ
```

### å‘½åç©ºé—´è§„èŒƒ
```php
// âœ… æ­£ç¡®çš„å‘½åç©ºé—´
namespace app\admin\controller;      // æ§åˆ¶å™¨
namespace app\admin\model;           // æ¨¡å‹
namespace app\common\library;        // å…¬å…±ç±»åº“
namespace app\api\validate;          // éªŒè¯å™¨

// âŒ é”™è¯¯çš„å‘½åç©ºé—´
namespace App\Admin\Controller;      // å¤§å†™å¼€å¤´
namespace app\admin;                 // ç¼ºå°‘å…·ä½“åˆ†ç±»
```

---

## ğŸ¯ æ§åˆ¶å™¨å¼€å‘è§„èŒƒ

### åŸºç¡€æ§åˆ¶å™¨ç»“æ„
```php
<?php
namespace app\admin\controller;

use think\Controller;
use think\Request;
use think\Db;
use think\Exception;
use think\exception\ValidateException;

/**
 * åŸºç¡€æ§åˆ¶å™¨ç±»
 */
class BaseController extends Controller
{
    /**
     * Requestå®ä¾‹
     * @var \think\Request
     */
    protected $request;
    
    /**
     * å½“å‰æ¨¡å‹å®ä¾‹
     */
    protected $model;
    
    /**
     * åˆå§‹åŒ–æ–¹æ³•
     */
    protected function initialize()
    {
        $this->request = Request::instance();
        
        // è·¨åŸŸå¤„ç†
        header('Access-Control-Allow-Origin: *');
        header('Access-Control-Allow-Headers: Authorization, Content-Type, If-Match, If-Modified-Since, If-None-Match, If-Unmodified-Since, X-Requested-With');
        header('Access-Control-Allow-Methods: GET, POST, PATCH, PUT, DELETE');
    }
    
    /**
     * æˆåŠŸå“åº”
     */
    protected function success($msg = 'success', $data = [], $code = 200)
    {
        return json([
            'code' => $code,
            'msg' => $msg,
            'data' => $data,
            'time' => time()
        ]);
    }
    
    /**
     * é”™è¯¯å“åº”
     */
    protected function error($msg = 'error', $data = [], $code = 400)
    {
        return json([
            'code' => $code,
            'msg' => $msg,
            'data' => $data,
            'time' => time()
        ]);
    }
}
```

### RESTfulæ§åˆ¶å™¨è§„èŒƒ
```php
<?php
namespace app\api\controller;

use app\common\controller\Api;
use app\common\model\User as UserModel;
use think\exception\ValidateException;

/**
 * RESTfulç”¨æˆ·æ§åˆ¶å™¨
 */
class User extends Api
{
    protected $model;
    
    protected function initialize()
    {
        parent::initialize();
        $this->model = new UserModel();
    }
    
    /**
     * è·å–ç”¨æˆ·åˆ—è¡¨
     * GET /api/user
     */
    public function index()
    {
        $page = $this->request->param('page', 1);
        $limit = $this->request->param('limit', 10);
        
        $users = $this->model
            ->field('id,username,nickname,email,status,create_time')
            ->where('status', 'normal')
            ->page($page, $limit)
            ->order('id desc')
            ->select();
            
        $total = $this->model->where('status', 'normal')->count();
        
        return $this->success('è·å–æˆåŠŸ', [
            'list' => $users,
            'total' => $total,
            'page' => $page,
            'limit' => $limit
        ]);
    }
    
    /**
     * è·å–å•ä¸ªç”¨æˆ·
     * GET /api/user/:id
     */
    public function read($id)
    {
        $user = $this->model
            ->field('id,username,nickname,email,avatar,status,create_time')
            ->find($id);
            
        if (!$user) {
            return $this->error('ç”¨æˆ·ä¸å­˜åœ¨', [], 404);
        }
        
        return $this->success('è·å–æˆåŠŸ', $user);
    }
    
    /**
     * åˆ›å»ºç”¨æˆ·
     * POST /api/user
     */
    public function save()
    {
        $data = $this->request->post();
        
        // éªŒè¯æ•°æ®
        $validate = new \app\api\validate\User();
        if (!$validate->scene('create')->check($data)) {
            return $this->error($validate->getError());
        }
        
        Db::startTrans();
        try {
            // å¯†ç åŠ å¯†
            if (isset($data['password'])) {
                $data['password'] = password_hash($data['password'], PASSWORD_DEFAULT);
            }
            
            $user = $this->model->create($data);
            Db::commit();
            
            return $this->success('åˆ›å»ºæˆåŠŸ', ['id' => $user->id]);
            
        } catch (\Exception $e) {
            Db::rollback();
            return $this->error('åˆ›å»ºå¤±è´¥ï¼š' . $e->getMessage());
        }
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·
     * PUT /api/user/:id
     */
    public function update($id)
    {
        $user = $this->model->find($id);
        if (!$user) {
            return $this->error('ç”¨æˆ·ä¸å­˜åœ¨', [], 404);
        }
        
        $data = $this->request->put();
        
        // éªŒè¯æ•°æ®
        $validate = new \app\api\validate\User();
        if (!$validate->scene('update')->check($data)) {
            return $this->error($validate->getError());
        }
        
        Db::startTrans();
        try {
            // æ’é™¤æ•æ„Ÿå­—æ®µ
            unset($data['password'], $data['id']);
            
            $user->save($data);
            Db::commit();
            
            return $this->success('æ›´æ–°æˆåŠŸ');
            
        } catch (\Exception $e) {
            Db::rollback();
            return $this->error('æ›´æ–°å¤±è´¥ï¼š' . $e->getMessage());
        }
    }
    
    /**
     * åˆ é™¤ç”¨æˆ·
     * DELETE /api/user/:id
     */
    public function delete($id)
    {
        $user = $this->model->find($id);
        if (!$user) {
            return $this->error('ç”¨æˆ·ä¸å­˜åœ¨', [], 404);
        }
        
        Db::startTrans();
        try {
            // è½¯åˆ é™¤
            $user->delete();
            Db::commit();
            
            return $this->success('åˆ é™¤æˆåŠŸ');
            
        } catch (\Exception $e) {
            Db::rollback();
            return $this->error('åˆ é™¤å¤±è´¥ï¼š' . $e->getMessage());
        }
    }
}
```

---

## ğŸ—ƒï¸ æ¨¡å‹å¼€å‘è§„èŒƒ

### æ¨¡å‹åŸºç¡€ç»“æ„
```php
<?php
namespace app\common\model;

use think\Model;
use think\model\concern\SoftDelete;

/**
 * ç”¨æˆ·æ¨¡å‹
 */
class User extends Model
{
    use SoftDelete;
    
    // è®¾ç½®å½“å‰æ¨¡å‹å¯¹åº”çš„å®Œæ•´æ•°æ®è¡¨åç§°
    protected $table = 'fa_user';
    
    // è®¾ç½®ä¸»é”®
    protected $pk = 'id';
    
    // è®¾ç½®å­—æ®µä¿¡æ¯
    protected $schema = [
        'id'          => 'int',
        'username'    => 'string',
        'password'    => 'string',
        'nickname'    => 'string',
        'email'       => 'string',
        'mobile'      => 'string',
        'avatar'      => 'string',
        'status'      => 'string',
        'create_time' => 'int',
        'update_time' => 'int',
        'delete_time' => 'int',
    ];
    
    // è‡ªåŠ¨æ—¶é—´æˆ³
    protected $autoWriteTimestamp = 'int';
    protected $createTime = 'create_time';
    protected $updateTime = 'update_time';
    protected $deleteTime = 'delete_time';
    
    // è½¯åˆ é™¤å­—æ®µé»˜è®¤å€¼
    protected $defaultSoftDelete = 0;
    
    // è¿½åŠ å±æ€§
    protected $append = [
        'status_text',
        'avatar_url'
    ];
    
    // éšè—å±æ€§
    protected $hidden = [
        'password',
        'delete_time'
    ];
    
    // ç±»å‹è½¬æ¢
    protected $type = [
        'create_time' => 'timestamp:Y-m-d H:i:s',
        'update_time' => 'timestamp:Y-m-d H:i:s',
    ];
    
    /**
     * çŠ¶æ€è·å–å™¨
     */
    public function getStatusTextAttr($value, $data)
    {
        $status = $data['status'] ?? '';
        $statusArray = [
            'normal' => 'æ­£å¸¸',
            'hidden' => 'ç¦ç”¨'
        ];
        return $statusArray[$status] ?? '';
    }
    
    /**
     * å¤´åƒè·å–å™¨
     */
    public function getAvatarUrlAttr($value, $data)
    {
        $avatar = $data['avatar'] ?? '';
        return $avatar ? cdnurl($avatar, true) : '/static/img/default-avatar.png';
    }
    
    /**
     * å¯†ç ä¿®æ”¹å™¨
     */
    public function setPasswordAttr($value)
    {
        return password_hash($value, PASSWORD_DEFAULT);
    }
    
    /**
     * æœç´¢å™¨ï¼šç”¨æˆ·å
     */
    public function searchUsernameAttr($query, $value)
    {
        $query->where('username', 'like', '%' . $value . '%');
    }
    
    /**
     * æœç´¢å™¨ï¼šçŠ¶æ€
     */
    public function searchStatusAttr($query, $value)
    {
        $query->where('status', '=', $value);
    }
    
    /**
     * å…³è”ç”¨æˆ·ç»„
     */
    public function userGroup()
    {
        return $this->belongsTo(UserGroup::class, 'group_id');
    }
    
    /**
     * å…³è”è§’è‰²ï¼ˆå¤šå¯¹å¤šï¼‰
     */
    public function roles()
    {
        return $this->belongsToMany(Role::class, 'user_role', 'role_id', 'user_id');
    }
    
    /**
     * éªŒè¯ç”¨æˆ·å¯†ç 
     */
    public function checkPassword($password)
    {
        return password_verify($password, $this->password);
    }
    
    /**
     * è·å–ç”¨æˆ·æƒé™
     */
    public function getPermissions()
    {
        return $this->roles()
            ->with('permissions')
            ->select()
            ->toArray();
    }
}
```

### å…³è”æŸ¥è¯¢è§„èŒƒ
```php
// âœ… é¢„åŠ è½½å…³è”é¿å…N+1æŸ¥è¯¢
$users = User::with(['userGroup', 'roles'])
    ->where('status', 'normal')
    ->select();

// âœ… å…³è”æŸ¥è¯¢æ¡ä»¶
$users = User::hasWhere('userGroup', ['status' => 'normal'])
    ->select();

// âœ… å…³è”ç»Ÿè®¡
$users = User::withCount('roles')
    ->select();

// âŒ é¿å…åœ¨å¾ªç¯ä¸­æŸ¥è¯¢å…³è”
foreach ($users as $user) {
    echo $user->userGroup->name; // N+1æŸ¥è¯¢é—®é¢˜
}
```

---

## âœ… éªŒè¯å™¨å¼€å‘è§„èŒƒ

### éªŒè¯å™¨ç»“æ„
```php
<?php
namespace app\api\validate;

use think\Validate;

/**
 * ç”¨æˆ·éªŒè¯å™¨
 */
class User extends Validate
{
    /**
     * éªŒè¯è§„åˆ™
     */
    protected $rule = [
        'username'  => 'require|length:3,30|alphaNum|unique:user',
        'password'  => 'require|length:6,30|confirm',
        'nickname'  => 'require|length:2,30|chs',
        'email'     => 'require|email|unique:user',
        'mobile'    => 'require|mobile|unique:user',
        'status'    => 'require|in:normal,hidden',
        'group_id'  => 'require|integer|gt:0',
        'avatar'    => 'image|fileSize:2048000|fileExt:jpg,png,gif',
    ];
    
    /**
     * éªŒè¯æ¶ˆæ¯
     */
    protected $message = [
        'username.require'   => 'ç”¨æˆ·åä¸èƒ½ä¸ºç©º',
        'username.length'    => 'ç”¨æˆ·åé•¿åº¦ä¸º3-30ä¸ªå­—ç¬¦',
        'username.alphaNum'  => 'ç”¨æˆ·ååªèƒ½æ˜¯å­—æ¯å’Œæ•°å­—',
        'username.unique'    => 'ç”¨æˆ·åå·²å­˜åœ¨',
        'password.require'   => 'å¯†ç ä¸èƒ½ä¸ºç©º',
        'password.length'    => 'å¯†ç é•¿åº¦ä¸º6-30ä¸ªå­—ç¬¦',
        'password.confirm'   => 'ä¸¤æ¬¡å¯†ç è¾“å…¥ä¸ä¸€è‡´',
        'nickname.require'   => 'æ˜µç§°ä¸èƒ½ä¸ºç©º',
        'nickname.chs'       => 'æ˜µç§°åªèƒ½æ˜¯ä¸­æ–‡',
        'email.email'        => 'é‚®ç®±æ ¼å¼ä¸æ­£ç¡®',
        'email.unique'       => 'é‚®ç®±å·²å­˜åœ¨',
        'mobile.mobile'      => 'æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®',
        'mobile.unique'      => 'æ‰‹æœºå·å·²å­˜åœ¨',
        'status.in'          => 'çŠ¶æ€å€¼ä¸æ­£ç¡®',
        'group_id.gt'        => 'ç”¨æˆ·ç»„IDå¿…é¡»å¤§äº0',
        'avatar.image'       => 'å¤´åƒå¿…é¡»æ˜¯å›¾ç‰‡',
        'avatar.fileSize'    => 'å¤´åƒå¤§å°ä¸èƒ½è¶…è¿‡2M',
        'avatar.fileExt'     => 'å¤´åƒåªèƒ½æ˜¯jpg,png,gifæ ¼å¼',
    ];
    
    /**
     * éªŒè¯åœºæ™¯
     */
    protected $scene = [
        'create' => ['username', 'password', 'nickname', 'email', 'mobile', 'status', 'group_id'],
        'update' => ['nickname', 'email', 'mobile', 'status', 'group_id'],
        'login'  => ['username', 'password'],
        'register' => ['username', 'password', 'nickname', 'email'],
        'change_password' => ['password'],
        'upload_avatar' => ['avatar'],
    ];
    
    /**
     * è‡ªå®šä¹‰éªŒè¯è§„åˆ™ï¼šæ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å­˜åœ¨ï¼ˆæ›´æ–°æ—¶æ’é™¤è‡ªå·±ï¼‰
     */
    protected function checkUsernameExists($value, $rule, $data = [])
    {
        $user_id = isset($data['id']) ? $data['id'] : 0;
        $count = \app\common\model\User::where('username', $value)
            ->where('id', '<>', $user_id)
            ->count();
            
        return $count == 0 ? true : 'ç”¨æˆ·åå·²å­˜åœ¨';
    }
    
    /**
     * è‡ªå®šä¹‰éªŒè¯è§„åˆ™ï¼šæ£€æŸ¥æ—§å¯†ç æ˜¯å¦æ­£ç¡®
     */
    protected function checkOldPassword($value, $rule, $data = [])
    {
        if (!isset($data['user_id'])) {
            return 'ç”¨æˆ·IDä¸èƒ½ä¸ºç©º';
        }
        
        $user = \app\common\model\User::find($data['user_id']);
        if (!$user) {
            return 'ç”¨æˆ·ä¸å­˜åœ¨';
        }
        
        return password_verify($value, $user->password) ? true : 'åŸå¯†ç ä¸æ­£ç¡®';
    }
}
```

---

## ğŸ”„ ä¸­é—´ä»¶å¼€å‘è§„èŒƒ

### ä¸­é—´ä»¶ç»“æ„
```php
<?php
namespace app\http\middleware;

use think\Request;
use think\Response;

/**
 * è®¤è¯ä¸­é—´ä»¶
 */
class Auth
{
    /**
     * å¤„ç†è¯·æ±‚
     */
    public function handle($request, \Closure $next)
    {
        // è·å–token
        $token = $request->header('Authorization');
        
        if (empty($token)) {
            return json(['code' => 401, 'msg' => 'è¯·å…ˆç™»å½•']);
        }
        
        // éªŒè¯token
        $user = $this->validateToken($token);
        if (!$user) {
            return json(['code' => 401, 'msg' => 'Tokenæ— æ•ˆ']);
        }
        
        // å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥åˆ°è¯·æ±‚ä¸­
        $request->user = $user;
        
        return $next($request);
    }
    
    /**
     * éªŒè¯Token
     */
    private function validateToken($token)
    {
        // ç§»é™¤Bearerå‰ç¼€
        $token = str_replace('Bearer ', '', $token);
        
        try {
            // è§£æJWT token
            $payload = \Firebase\JWT\JWT::decode($token, config('jwt.key'), ['HS256']);
            
            // æŸ¥æ‰¾ç”¨æˆ·
            $user = \app\common\model\User::find($payload->user_id);
            
            return $user && $user->status === 'normal' ? $user : null;
            
        } catch (\Exception $e) {
            return null;
        }
    }
}
```

### è·¨åŸŸä¸­é—´ä»¶
```php
<?php
namespace app\http\middleware;

/**
 * è·¨åŸŸä¸­é—´ä»¶
 */
class Cors
{
    public function handle($request, \Closure $next)
    {
        header('Access-Control-Allow-Origin: *');
        header('Access-Control-Allow-Headers: Authorization, Content-Type, If-Match, If-Modified-Since, If-None-Match, If-Unmodified-Since, X-Requested-With');
        header('Access-Control-Allow-Methods: GET, POST, PATCH, PUT, DELETE, OPTIONS');
        
        // å¤„ç†é¢„æ£€è¯·æ±‚
        if ($request->method() == 'OPTIONS') {
            return response('', 200);
        }
        
        return $next($request);
    }
}
```

---

## ğŸ“Š æ•°æ®åº“æ“ä½œè§„èŒƒ

### æŸ¥è¯¢æ„é€ å™¨ä½¿ç”¨
```php
// âœ… åŸºç¡€æŸ¥è¯¢
$users = Db::name('user')
    ->field('id,username,nickname,email')
    ->where('status', 'normal')
    ->where('create_time', '>', strtotime('-30 days'))
    ->order('id desc')
    ->limit(10)
    ->select();

// âœ… å¤æ‚æŸ¥è¯¢
$users = Db::name('user')
    ->alias('u')
    ->join('user_group g', 'u.group_id = g.id')
    ->field('u.id,u.username,u.nickname,g.name as group_name')
    ->where('u.status', 'normal')
    ->whereIn('g.id', [1, 2, 3])
    ->select();

// âœ… èšåˆæŸ¥è¯¢
$stats = Db::name('user')
    ->field('status, COUNT(*) as count')
    ->group('status')
    ->select();

// âœ… å­æŸ¥è¯¢
$subQuery = Db::name('user_role')
    ->field('user_id')
    ->where('role_id', 1)
    ->buildSql();
    
$users = Db::name('user')
    ->where('id', 'in', $subQuery)
    ->select();
```

### äº‹åŠ¡å¤„ç†è§„èŒƒ
```php
// âœ… è‡ªåŠ¨äº‹åŠ¡
Db::transaction(function () {
    // åˆ›å»ºç”¨æˆ·
    $userId = Db::name('user')->insertGetId([
        'username' => 'test',
        'password' => password_hash('123456', PASSWORD_DEFAULT),
        'create_time' => time()
    ]);
    
    // åˆ†é…è§’è‰²
    Db::name('user_role')->insert([
        'user_id' => $userId,
        'role_id' => 2,
        'create_time' => time()
    ]);
});

// âœ… æ‰‹åŠ¨äº‹åŠ¡
Db::startTrans();
try {
    // ä¸šåŠ¡é€»è¾‘
    $result1 = Db::name('user')->insert($userData);
    $result2 = Db::name('user_profile')->insert($profileData);
    
    if ($result1 && $result2) {
        Db::commit();
        return true;
    } else {
        Db::rollback();
        return false;
    }
} catch (\Exception $e) {
    Db::rollback();
    throw $e;
}
```

---

## ğŸ¨ è§†å›¾å’Œæ¨¡æ¿è§„èŒƒ

### æ¨¡æ¿ç»§æ‰¿
```html
<!-- layout/base.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>{block name="title"}é»˜è®¤æ ‡é¢˜{/block}</title>
    {block name="css"}{/block}
</head>
<body>
    <div class="container">
        {block name="content"}{/block}
    </div>
    {block name="js"}{/block}
</body>
</html>

<!-- user/index.html -->
{extend name="layout/base" /}

{block name="title"}ç”¨æˆ·åˆ—è¡¨{/block}

{block name="css"}
<style>
    .user-list { margin: 20px 0; }
</style>
{/block}

{block name="content"}
<div class="user-list">
    {volist name="users" id="user"}
    <div class="user-item">
        <h3>{$user.nickname}</h3>
        <p>{$user.email}</p>
    </div>
    {/volist}
</div>
{/block}

{block name="js"}
<script>
    console.log('ç”¨æˆ·åˆ—è¡¨é¡µé¢');
</script>
{/block}
```

### æ¨¡æ¿æ ‡ç­¾ä½¿ç”¨
```html
<!-- æ¡ä»¶åˆ¤æ–­ -->
{if condition="$user.status eq 'normal'"}
    <span class="label label-success">æ­£å¸¸</span>
{elseif condition="$user.status eq 'hidden'"}
    <span class="label label-danger">ç¦ç”¨</span>
{else/}
    <span class="label label-default">æœªçŸ¥</span>
{/if}

<!-- å¾ªç¯è¾“å‡º -->
{volist name="users" id="user" key="key"}
    <tr data-id="{$user.id}">
        <td>{$key}</td>
        <td>{$user.username}</td>
        <td>{$user.nickname|default='æœªè®¾ç½®'}</td>
        <td>{$user.create_time|date='Y-m-d H:i:s'}</td>
    </tr>
{empty/}
    <tr><td colspan="4">æš‚æ— æ•°æ®</td></tr>
{/volist}

<!-- å˜é‡è¾“å‡º -->
{$user.username}                    <!-- æ™®é€šè¾“å‡º -->
{$user.username|upper}              <!-- ä½¿ç”¨å‡½æ•° -->
{$user.content|raw}                 <!-- åŸæ ·è¾“å‡º -->
{$user.nickname|default='æ¸¸å®¢'}      <!-- é»˜è®¤å€¼ -->
```

---

## ğŸ› ï¸ å‘½ä»¤è¡Œå¼€å‘è§„èŒƒ

### å‘½ä»¤ç±»ç»“æ„
```php
<?php
namespace app\command;

use think\console\Command;
use think\console\Input;
use think\console\Output;
use app\common\model\User;

/**
 * ç”¨æˆ·ç›¸å…³å‘½ä»¤
 */
class UserCommand extends Command
{
    protected function configure()
    {
        $this->setName('user:create')
            ->setDescription('åˆ›å»ºç”¨æˆ·')
            ->addArgument('username', null, 'ç”¨æˆ·å')
            ->addArgument('password', null, 'å¯†ç ')
            ->addOption('email', 'e', null, 'é‚®ç®±')
            ->addOption('nickname', 'n', null, 'æ˜µç§°');
    }
    
    protected function execute(Input $input, Output $output)
    {
        $username = $input->getArgument('username');
        $password = $input->getArgument('password');
        $email = $input->getOption('email');
        $nickname = $input->getOption('nickname');
        
        if (empty($username) || empty($password)) {
            $output->error('ç”¨æˆ·åå’Œå¯†ç ä¸èƒ½ä¸ºç©º');
            return;
        }
        
        try {
            $user = User::create([
                'username' => $username,
                'password' => $password,
                'email' => $email,
                'nickname' => $nickname ?: $username,
                'status' => 'normal',
                'create_time' => time()
            ]);
            
            $output->info('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼ŒID: ' . $user->id);
            
        } catch (\Exception $e) {
            $output->error('ç”¨æˆ·åˆ›å»ºå¤±è´¥: ' . $e->getMessage());
        }
    }
}
```

### å®šæ—¶ä»»åŠ¡å‘½ä»¤
```php
<?php
namespace app\command;

use think\console\Command;
use think\console\Input;
use think\console\Output;
use think\Db;

/**
 * æ•°æ®æ¸…ç†å‘½ä»¤
 */
class CleanCommand extends Command
{
    protected function configure()
    {
        $this->setName('clean:data')
            ->setDescription('æ¸…ç†è¿‡æœŸæ•°æ®')
            ->addOption('days', 'd', null, 'ä¿ç•™å¤©æ•°', 30);
    }
    
    protected function execute(Input $input, Output $output)
    {
        $days = (int)$input->getOption('days');
        $expireTime = time() - ($days * 24 * 3600);
        
        $output->writeln('å¼€å§‹æ¸…ç† ' . $days . ' å¤©å‰çš„æ•°æ®...');
        
        // æ¸…ç†æ—¥å¿—
        $logCount = Db::name('admin_log')
            ->where('create_time', '<', $expireTime)
            ->delete();
            
        $output->info('æ¸…ç†æ—¥å¿—è®°å½•: ' . $logCount . ' æ¡');
        
        // æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        $tempCount = Db::name('attachment')
            ->where('create_time', '<', $expireTime)
            ->where('category', 'temp')
            ->delete();
            
        $output->info('æ¸…ç†ä¸´æ—¶æ–‡ä»¶: ' . $tempCount . ' ä¸ª');
        
        $output->info('æ•°æ®æ¸…ç†å®Œæˆ');
    }
}
```

---

## ğŸ”§ é…ç½®ç®¡ç†è§„èŒƒ

### åº”ç”¨é…ç½®
```php
// application/config.php
return [
    // åº”ç”¨é…ç½®
    'app_debug'              => env('APP_DEBUG', false),
    'app_trace'              => env('APP_TRACE', false),
    
    // æ•°æ®åº“é…ç½®
    'database'               => [
        'type'            => env('DATABASE_TYPE', 'mysql'),
        'hostname'        => env('DATABASE_HOSTNAME', '127.0.0.1'),
        'database'        => env('DATABASE_DATABASE', ''),
        'username'        => env('DATABASE_USERNAME', 'root'),
        'password'        => env('DATABASE_PASSWORD', ''),
        'hostport'        => env('DATABASE_HOSTPORT', '3306'),
        'params'          => [],
        'charset'         => 'utf8mb4',
        'prefix'          => env('DATABASE_PREFIX', 'fa_'),
        'debug'           => env('DATABASE_DEBUG', false),
    ],
    
    // ç¼“å­˜é…ç½®
    'cache'                  => [
        'type'   => 'Redis',
        'host'   => env('REDIS_HOSTNAME', '127.0.0.1'),
        'port'   => env('REDIS_PORT', 6379),
        'password' => env('REDIS_PASSWORD', ''),
        'select' => env('REDIS_SELECT', 0),
        'timeout' => 0,
        'expire' => 0,
        'persistent' => false,
        'prefix' => env('CACHE_PREFIX', 'think:'),
    ],
    
    // ä¼šè¯é…ç½®
    'session'                => [
        'id'             => '',
        'var_session_id' => '',
        'prefix'         => 'think',
        'type'           => 'redis',
        'auto_start'     => true,
        'httponly'       => true,
        'secure'         => false,
    ],
];
```

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env
APP_DEBUG = true
APP_TRACE = false

# æ•°æ®åº“é…ç½®
DATABASE_TYPE = mysql
DATABASE_HOSTNAME = 127.0.0.1
DATABASE_DATABASE = fastadmin
DATABASE_USERNAME = root
DATABASE_PASSWORD = 
DATABASE_HOSTPORT = 3306
DATABASE_PREFIX = fa_

# Redisé…ç½®
REDIS_HOSTNAME = 127.0.0.1
REDIS_PORT = 6379
REDIS_PASSWORD = 
REDIS_SELECT = 0

# ç¼“å­˜é…ç½®
CACHE_PREFIX = fastadmin:

# JWTé…ç½®
JWT_KEY = your-secret-key
JWT_EXPIRE = 7200
```

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### æŸ¥è¯¢ä¼˜åŒ–
```php
// âœ… ä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
$users = User::where('username', $username)->find();

// âœ… é™åˆ¶æŸ¥è¯¢å­—æ®µ
$users = User::field('id,username,nickname')->select();

// âœ… ä½¿ç”¨ç¼“å­˜
$users = cache('user_list', function() {
    return User::where('status', 'normal')->select();
}, 300);

// âœ… åˆ†é¡µæŸ¥è¯¢
$users = User::paginate(10);

// âŒ é¿å…å…¨è¡¨æ‰«æ
$users = User::where('nickname', 'like', '%test%')->select(); // å¦‚æœnicknameæ²¡æœ‰ç´¢å¼•

// âŒ é¿å…æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
$users = User::select(); // æŸ¥è¯¢æ‰€æœ‰å­—æ®µ
```

### ç¼“å­˜ä½¿ç”¨
```php
// âœ… æ•°æ®ç¼“å­˜
$user = cache('user_' . $id, function() use ($id) {
    return User::find($id);
}, 300);

// âœ… æŸ¥è¯¢ç»“æœç¼“å­˜
$users = User::cache(300)->where('status', 'normal')->select();

// âœ… æ ‡ç­¾ç¼“å­˜
cache('user_list', $users, 300, 'user');
cache('user_count', $count, 300, 'user');

// æ¸…é™¤æ ‡ç­¾ç¼“å­˜
\think\Cache::clear('user');
```

---

## ğŸ”’ å®‰å…¨è§„èŒƒ

### è¾“å…¥éªŒè¯
```php
// âœ… ä½¿ç”¨éªŒè¯å™¨
$validate = new \app\api\validate\User();
if (!$validate->check($data)) {
    return $this->error($validate->getError());
}

// âœ… è¿‡æ»¤å±é™©å­—ç¬¦
$data = $this->request->filter(['strip_tags', 'trim'])->post();

// âœ… ç±»å‹è½¬æ¢
$id = (int)$this->request->param('id');
$page = max(1, (int)$this->request->param('page', 1));
```

### SQLæ³¨å…¥é˜²æŠ¤
```php
// âœ… ä½¿ç”¨å‚æ•°ç»‘å®š
$users = Db::name('user')
    ->where('username', '=', $username)
    ->where('status', '=', $status)
    ->select();

// âœ… ä½¿ç”¨whereRawæ—¶ç»‘å®šå‚æ•°
$users = Db::name('user')
    ->whereRaw('username = ? AND status = ?', [$username, $status])
    ->select();

// âŒ é¿å…å­—ç¬¦ä¸²æ‹¼æ¥
$sql = "SELECT * FROM user WHERE username = '{$username}'"; // å±é™©ï¼
```

### æƒé™æ§åˆ¶
```php
// æ§åˆ¶å™¨æƒé™æ£€æŸ¥
public function edit()
{
    $id = $this->request->param('id');
    
    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™
    if (!$this->checkPermission('user.edit')) {
        return $this->error('æ— æƒé™æ“ä½œ');
    }
    
    // æ£€æŸ¥æ˜¯å¦åªèƒ½ç¼–è¾‘è‡ªå·±çš„æ•°æ®
    if ($this->isDataLimited() && !$this->checkDataOwnership($id)) {
        return $this->error('åªèƒ½ç¼–è¾‘è‡ªå·±çš„æ•°æ®');
    }
}
```

---

## ğŸ“ ä»£ç è´¨é‡æ ‡å‡†

### å¿…é¡»éµå¾ªçš„è§„åˆ™
1. **æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿å¯¹åº”åŸºç±»**
2. **æ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»ä½¿ç”¨äº‹åŠ¡**
3. **æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»éªŒè¯**
4. **æ‰€æœ‰æŸ¥è¯¢å¿…é¡»ä½¿ç”¨å‚æ•°ç»‘å®š**
5. **æ‰€æœ‰æ•æ„Ÿæ“ä½œå¿…é¡»è®°å½•æ—¥å¿—**
6. **æ‰€æœ‰å¼‚å¸¸å¿…é¡»æ•è·å¤„ç†**
7. **æ‰€æœ‰æ¥å£å¿…é¡»æœ‰æƒé™æ§åˆ¶**
8. **æ‰€æœ‰ç¼“å­˜å¿…é¡»è®¾ç½®è¿‡æœŸæ—¶é—´**

### ä»£ç å®¡æŸ¥è¦ç‚¹
- [ ] æ˜¯å¦éµå¾ªPSRè§„èŒƒ
- [ ] æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„å‘½åè§„èŒƒ
- [ ] æ˜¯å¦è¿›è¡Œäº†è¾“å…¥éªŒè¯
- [ ] æ˜¯å¦æœ‰SQLæ³¨å…¥é£é™©
- [ ] æ˜¯å¦æœ‰æƒé™æ§åˆ¶
- [ ] æ˜¯å¦æœ‰å¼‚å¸¸å¤„ç†
- [ ] æ˜¯å¦ä½¿ç”¨äº†äº‹åŠ¡
- [ ] æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜

---

**æ³¨æ„**: æœ¬è§„èŒƒåŸºäºThinkPHP 5.1æ¡†æ¶ï¼Œå¼€å‘æ—¶åº”ä¸¥æ ¼éµå¾ªä»¥ç¡®ä¿ä»£ç è´¨é‡å’Œå®‰å…¨æ€§ã€‚