---
alwaysApply: true
priority: 5
techStack: "FastAdmin Security"
---

# FastAdmin å®‰å…¨å¼€å‘æ ‡å‡†è§„èŒƒ

> **å®‰å…¨ç­‰çº§**: é«˜å®‰å…¨æ€§è¦æ±‚
> **é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒã€æ•æ„Ÿæ•°æ®å¤„ç†ã€æƒé™ç®¡ç†

---

## ğŸ” èº«ä»½è®¤è¯å®‰å…¨

### å¯†ç å®‰å…¨è§„èŒƒ
```php
/**
 * å¯†ç åŠ å¯†å­˜å‚¨
 */
class PasswordSecurity
{
    /**
     * ç”Ÿæˆå®‰å…¨å¯†ç å“ˆå¸Œ
     */
    public static function hashPassword($password, $salt = '')
    {
        // ä½¿ç”¨bcryptç®—æ³•
        if (empty($salt)) {
            return password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);
        }
        
        // å…¼å®¹æ—§ç‰ˆæœ¬çš„MD5+ç›å€¼æ–¹å¼
        return md5(md5($password) . $salt);
    }
    
    /**
     * éªŒè¯å¯†ç 
     */
    public static function verifyPassword($password, $hash, $salt = '')
    {
        if (empty($salt)) {
            return password_verify($password, $hash);
        }
        
        return hash_equals($hash, md5(md5($password) . $salt));
    }
    
    /**
     * ç”Ÿæˆå®‰å…¨çš„éšæœºç›å€¼
     */
    public static function generateSalt($length = 30)
    {
        return \fast\Random::alnum($length);
    }
    
    /**
     * å¯†ç å¼ºåº¦æ£€æŸ¥
     */
    public static function checkPasswordStrength($password)
    {
        $errors = [];
        
        if (strlen($password) < 8) {
            $errors[] = 'å¯†ç é•¿åº¦è‡³å°‘8ä½';
        }
        
        if (!preg_match('/[a-z]/', $password)) {
            $errors[] = 'å¯†ç å¿…é¡»åŒ…å«å°å†™å­—æ¯';
        }
        
        if (!preg_match('/[A-Z]/', $password)) {
            $errors[] = 'å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯';
        }
        
        if (!preg_match('/[0-9]/', $password)) {
            $errors[] = 'å¯†ç å¿…é¡»åŒ…å«æ•°å­—';
        }
        
        if (!preg_match('/[^a-zA-Z0-9]/', $password)) {
            $errors[] = 'å¯†ç å¿…é¡»åŒ…å«ç‰¹æ®Šå­—ç¬¦';
        }
        
        return empty($errors) ? true : $errors;
    }
}
```

### Tokenå®‰å…¨ç®¡ç†
```php
/**
 * JWT Tokenå®‰å…¨ç®¡ç†
 */
class TokenSecurity
{
    /**
     * ç”ŸæˆJWT Token
     */
    public static function generateToken($payload, $expire = 7200)
    {
        $header = [
            'typ' => 'JWT',
            'alg' => 'HS256'
        ];
        
        $payload['iat'] = time();
        $payload['exp'] = time() + $expire;
        $payload['jti'] = uniqid(); // é˜²æ­¢é‡æ”¾æ”»å‡»
        
        $headerEncoded = self::base64UrlEncode(json_encode($header));
        $payloadEncoded = self::base64UrlEncode(json_encode($payload));
        
        $signature = hash_hmac('sha256', $headerEncoded . '.' . $payloadEncoded, config('app.app_key'), true);
        $signatureEncoded = self::base64UrlEncode($signature);
        
        return $headerEncoded . '.' . $payloadEncoded . '.' . $signatureEncoded;
    }
    
    /**
     * éªŒè¯JWT Token
     */
    public static function verifyToken($token)
    {
        $parts = explode('.', $token);
        if (count($parts) !== 3) {
            return false;
        }
        
        list($headerEncoded, $payloadEncoded, $signatureEncoded) = $parts;
        
        // éªŒè¯ç­¾å
        $signature = hash_hmac('sha256', $headerEncoded . '.' . $payloadEncoded, config('app.app_key'), true);
        $signatureCheck = self::base64UrlEncode($signature);
        
        if (!hash_equals($signatureCheck, $signatureEncoded)) {
            return false;
        }
        
        $payload = json_decode(self::base64UrlDecode($payloadEncoded), true);
        
        // æ£€æŸ¥è¿‡æœŸæ—¶é—´
        if (isset($payload['exp']) && $payload['exp'] < time()) {
            return false;
        }
        
        // æ£€æŸ¥Tokené»‘åå•
        if (self::isTokenBlacklisted($payload['jti'] ?? '')) {
            return false;
        }
        
        return $payload;
    }
    
    /**
     * å°†TokenåŠ å…¥é»‘åå•
     */
    public static function blacklistToken($jti)
    {
        cache('token_blacklist_' . $jti, true, 86400); // 24å°æ—¶è¿‡æœŸ
    }
    
    /**
     * æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
     */
    public static function isTokenBlacklisted($jti)
    {
        return cache('token_blacklist_' . $jti) ? true : false;
    }
    
    private static function base64UrlEncode($data)
    {
        return rtrim(strtr(base64_encode($data), '+/', '-_'), '=');
    }
    
    private static function base64UrlDecode($data)
    {
        return base64_decode(str_pad(strtr($data, '-_', '+/'), strlen($data) % 4, '=', STR_PAD_RIGHT));
    }
}
```

### ç™»å½•å®‰å…¨æ§åˆ¶
```php
/**
 * ç™»å½•å®‰å…¨æ§åˆ¶
 */
class LoginSecurity
{
    /**
     * ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
     */
    public static function checkLoginAttempts($username, $ip)
    {
        $usernameKey = 'login_attempts_user_' . md5($username);
        $ipKey = 'login_attempts_ip_' . md5($ip);
        
        $userAttempts = cache($usernameKey) ?: 0;
        $ipAttempts = cache($ipKey) ?: 0;
        
        // ç”¨æˆ·å5æ¬¡å¤±è´¥é”å®š30åˆ†é’Ÿ
        if ($userAttempts >= 5) {
            return ['locked' => true, 'message' => 'ç”¨æˆ·åç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·30åˆ†é’Ÿåé‡è¯•'];
        }
        
        // IPåœ°å€10æ¬¡å¤±è´¥é”å®š1å°æ—¶
        if ($ipAttempts >= 10) {
            return ['locked' => true, 'message' => 'IPåœ°å€ç™»å½•å¤±è´¥æ¬¡æ•°è¿‡å¤šï¼Œè¯·1å°æ—¶åé‡è¯•'];
        }
        
        return ['locked' => false];
    }
    
    /**
     * è®°å½•ç™»å½•å¤±è´¥
     */
    public static function recordLoginFailure($username, $ip)
    {
        $usernameKey = 'login_attempts_user_' . md5($username);
        $ipKey = 'login_attempts_ip_' . md5($ip);
        
        $userAttempts = cache($usernameKey) ?: 0;
        $ipAttempts = cache($ipKey) ?: 0;
        
        cache($usernameKey, $userAttempts + 1, 1800); // 30åˆ†é’Ÿ
        cache($ipKey, $ipAttempts + 1, 3600); // 1å°æ—¶
    }
    
    /**
     * æ¸…é™¤ç™»å½•å¤±è´¥è®°å½•
     */
    public static function clearLoginFailures($username, $ip)
    {
        $usernameKey = 'login_attempts_user_' . md5($username);
        $ipKey = 'login_attempts_ip_' . md5($ip);
        
        cache($usernameKey, null);
        cache($ipKey, null);
    }
    
    /**
     * æ£€æŸ¥éªŒè¯ç 
     */
    public static function checkCaptcha($code, $id = '')
    {
        if (empty($code)) {
            return false;
        }
        
        return captcha_check($code, $id);
    }
    
    /**
     * æ£€æŸ¥è®¾å¤‡æŒ‡çº¹
     */
    public static function checkDeviceFingerprint($fingerprint, $userId)
    {
        $knownDevices = cache('user_devices_' . $userId) ?: [];
        
        if (!in_array($fingerprint, $knownDevices)) {
            // æ–°è®¾å¤‡ï¼Œéœ€è¦é¢å¤–éªŒè¯
            return ['new_device' => true, 'message' => 'æ£€æµ‹åˆ°æ–°è®¾å¤‡ç™»å½•ï¼Œè¯·è¿›è¡Œå®‰å…¨éªŒè¯'];
        }
        
        return ['new_device' => false];
    }
}
```

---

## ğŸ›¡ï¸ è¾“å…¥éªŒè¯ä¸è¿‡æ»¤

### æ•°æ®éªŒè¯å®‰å…¨
```php
/**
 * è¾“å…¥æ•°æ®å®‰å…¨éªŒè¯
 */
class InputSecurity
{
    /**
     * éªŒè¯å’Œè¿‡æ»¤ç”¨æˆ·è¾“å…¥
     */
    public static function validateAndFilter($data, $rules = [])
    {
        // 1. æ•°æ®ç±»å‹éªŒè¯
        foreach ($rules as $field => $rule) {
            if (isset($data[$field])) {
                $data[$field] = self::validateField($data[$field], $rule);
            }
        }
        
        // 2. XSSè¿‡æ»¤
        $data = self::filterXSS($data);
        
        // 3. SQLæ³¨å…¥é˜²æŠ¤ï¼ˆé€šè¿‡å‚æ•°ç»‘å®šå®ç°ï¼‰
        $data = self::escapeSQLInjection($data);
        
        // 4. æ–‡ä»¶è·¯å¾„éå†é˜²æŠ¤
        $data = self::filterPathTraversal($data);
        
        return $data;
    }
    
    /**
     * å­—æ®µéªŒè¯
     */
    private static function validateField($value, $rule)
    {
        $rules = explode('|', $rule);
        
        foreach ($rules as $r) {
            if (strpos($r, ':') !== false) {
                list($ruleName, $ruleValue) = explode(':', $r, 2);
            } else {
                $ruleName = $r;
                $ruleValue = null;
            }
            
            switch ($ruleName) {
                case 'required':
                    if (empty($value)) {
                        throw new \Exception('å­—æ®µä¸èƒ½ä¸ºç©º');
                    }
                    break;
                    
                case 'length':
                    list($min, $max) = explode(',', $ruleValue);
                    if (strlen($value) < $min || strlen($value) > $max) {
                        throw new \Exception("å­—æ®µé•¿åº¦å¿…é¡»åœ¨{$min}-{$max}ä¹‹é—´");
                    }
                    break;
                    
                case 'email':
                    if (!filter_var($value, FILTER_VALIDATE_EMAIL)) {
                        throw new \Exception('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
                    }
                    break;
                    
                case 'url':
                    if (!filter_var($value, FILTER_VALIDATE_URL)) {
                        throw new \Exception('URLæ ¼å¼ä¸æ­£ç¡®');
                    }
                    break;
                    
                case 'integer':
                    if (!filter_var($value, FILTER_VALIDATE_INT)) {
                        throw new \Exception('å¿…é¡»æ˜¯æ•´æ•°');
                    }
                    $value = (int)$value;
                    break;
                    
                case 'float':
                    if (!filter_var($value, FILTER_VALIDATE_FLOAT)) {
                        throw new \Exception('å¿…é¡»æ˜¯æµ®ç‚¹æ•°');
                    }
                    $value = (float)$value;
                    break;
                    
                case 'regex':
                    if (!preg_match($ruleValue, $value)) {
                        throw new \Exception('æ ¼å¼ä¸æ­£ç¡®');
                    }
                    break;
            }
        }
        
        return $value;
    }
    
    /**
     * XSSè¿‡æ»¤
     */
    public static function filterXSS($data)
    {
        if (is_array($data)) {
            return array_map([self::class, 'filterXSS'], $data);
        }
        
        if (!is_string($data)) {
            return $data;
        }
        
        // ç§»é™¤å±é™©æ ‡ç­¾
        $data = preg_replace('/<script[^>]*?>.*?<\/script>/si', '', $data);
        $data = preg_replace('/<iframe[^>]*?>.*?<\/iframe>/si', '', $data);
        $data = preg_replace('/<object[^>]*?>.*?<\/object>/si', '', $data);
        $data = preg_replace('/<embed[^>]*?>/si', '', $data);
        $data = preg_replace('/<applet[^>]*?>.*?<\/applet>/si', '', $data);
        
        // ç§»é™¤å±é™©å±æ€§
        $data = preg_replace('/on\w+\s*=\s*["\'][^"\']*["\']/i', '', $data);
        $data = preg_replace('/javascript\s*:/i', '', $data);
        $data = preg_replace('/vbscript\s*:/i', '', $data);
        $data = preg_replace('/data\s*:/i', '', $data);
        
        return $data;
    }
    
    /**
     * SQLæ³¨å…¥é˜²æŠ¤
     */
    public static function escapeSQLInjection($data)
    {
        if (is_array($data)) {
            return array_map([self::class, 'escapeSQLInjection'], $data);
        }
        
        if (!is_string($data)) {
            return $data;
        }
        
        // ç§»é™¤SQLå…³é”®å­—ï¼ˆä»…ä½œä¸ºè¾…åŠ©é˜²æŠ¤ï¼Œä¸»è¦è¿˜æ˜¯é å‚æ•°ç»‘å®šï¼‰
        $sqlKeywords = ['SELECT', 'INSERT', 'UPDATE', 'DELETE', 'DROP', 'CREATE', 'ALTER', 'EXEC', 'UNION', 'SCRIPT'];
        $pattern = '/\b(' . implode('|', $sqlKeywords) . ')\b/i';
        
        if (preg_match($pattern, $data)) {
            \think\Log::warning('Potential SQL injection attempt: ' . $data);
        }
        
        return $data;
    }
    
    /**
     * è·¯å¾„éå†é˜²æŠ¤
     */
    public static function filterPathTraversal($data)
    {
        if (is_array($data)) {
            return array_map([self::class, 'filterPathTraversal'], $data);
        }
        
        if (!is_string($data)) {
            return $data;
        }
        
        // ç§»é™¤è·¯å¾„éå†å­—ç¬¦
        $data = str_replace(['../', '.\\', '../', '..\\'], '', $data);
        $data = preg_replace('/\.{2,}/', '.', $data);
        
        return $data;
    }
}
```

### æ–‡ä»¶ä¸Šä¼ å®‰å…¨
```php
/**
 * æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ§åˆ¶
 */
class UploadSecurity
{
    // å…è®¸çš„æ–‡ä»¶ç±»å‹
    private static $allowedTypes = [
        'image' => ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'],
        'document' => ['pdf', 'doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'],
        'video' => ['mp4', 'avi', 'mov', 'wmv', 'flv'],
        'audio' => ['mp3', 'wav', 'flac', 'aac']
    ];
    
    // å±é™©æ–‡ä»¶æ‰©å±•å
    private static $dangerousExtensions = [
        'php', 'php3', 'php4', 'php5', 'phtml', 'pht',
        'jsp', 'asp', 'aspx', 'cer', 'asa', 'cdx',
        'exe', 'bat', 'cmd', 'com', 'pif', 'scr',
        'js', 'jar', 'vb', 'vbs', 'sh'
    ];
    
    /**
     * éªŒè¯æ–‡ä»¶ä¸Šä¼ å®‰å…¨æ€§
     */
    public static function validateUpload($file, $type = 'image')
    {
        $errors = [];
        
        // 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if (!$file || !$file->isValid()) {
            $errors[] = 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥';
            return $errors;
        }
        
        // 2. æ£€æŸ¥æ–‡ä»¶å¤§å°
        $maxSize = self::getMaxFileSize($type);
        if ($file->getSize() > $maxSize) {
            $errors[] = 'æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶ï¼š' . self::formatFileSize($maxSize);
        }
        
        // 3. æ£€æŸ¥æ–‡ä»¶æ‰©å±•å
        $extension = strtolower($file->getOriginalExtension());
        if (in_array($extension, self::$dangerousExtensions)) {
            $errors[] = 'ä¸å…è®¸ä¸Šä¼ çš„æ–‡ä»¶ç±»å‹ï¼š' . $extension;
        }
        
        if (!in_array($extension, self::$allowedTypes[$type] ?? [])) {
            $errors[] = 'ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ï¼š' . $extension;
        }
        
        // 4. æ£€æŸ¥MIMEç±»å‹
        $mimeType = $file->getMime();
        if (!self::isValidMimeType($mimeType, $type)) {
            $errors[] = 'æ— æ•ˆçš„MIMEç±»å‹ï¼š' . $mimeType;
        }
        
        // 5. æ£€æŸ¥æ–‡ä»¶å¤´éƒ¨
        if ($type === 'image' && !self::isValidImageHeader($file->getPathname())) {
            $errors[] = 'æ— æ•ˆçš„å›¾ç‰‡æ–‡ä»¶';
        }
        
        // 6. ç—…æ¯’æ‰«æï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if (config('upload.virus_scan') && !self::virusScan($file->getPathname())) {
            $errors[] = 'æ–‡ä»¶åŒ…å«æ¶æ„ä»£ç ';
        }
        
        return $errors;
    }
    
    /**
     * è·å–æœ€å¤§æ–‡ä»¶å¤§å°
     */
    private static function getMaxFileSize($type)
    {
        $sizes = [
            'image' => 2 * 1024 * 1024,      // 2MB
            'document' => 10 * 1024 * 1024,  // 10MB
            'video' => 100 * 1024 * 1024,    // 100MB
            'audio' => 20 * 1024 * 1024      // 20MB
        ];
        
        return $sizes[$type] ?? 2 * 1024 * 1024;
    }
    
    /**
     * éªŒè¯MIMEç±»å‹
     */
    private static function isValidMimeType($mimeType, $type)
    {
        $validMimes = [
            'image' => ['image/jpeg', 'image/png', 'image/gif', 'image/bmp', 'image/webp'],
            'document' => ['application/pdf', 'application/msword', 'application/vnd.ms-excel', 'text/plain'],
            'video' => ['video/mp4', 'video/avi', 'video/quicktime', 'video/x-msvideo'],
            'audio' => ['audio/mpeg', 'audio/wav', 'audio/flac', 'audio/aac']
        ];
        
        return in_array($mimeType, $validMimes[$type] ?? []);
    }
    
    /**
     * éªŒè¯å›¾ç‰‡æ–‡ä»¶å¤´éƒ¨
     */
    private static function isValidImageHeader($filepath)
    {
        $handle = fopen($filepath, 'rb');
        if (!$handle) {
            return false;
        }
        
        $header = fread($handle, 10);
        fclose($handle);
        
        // æ£€æŸ¥å¸¸è§å›¾ç‰‡æ ¼å¼çš„æ–‡ä»¶å¤´
        $imageHeaders = [
            'jpeg' => [0xFF, 0xD8, 0xFF],
            'png' => [0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A],
            'gif' => [0x47, 0x49, 0x46],
            'bmp' => [0x42, 0x4D]
        ];
        
        foreach ($imageHeaders as $format => $bytes) {
            if (self::checkFileHeader($header, $bytes)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * æ£€æŸ¥æ–‡ä»¶å¤´éƒ¨å­—èŠ‚
     */
    private static function checkFileHeader($header, $expectedBytes)
    {
        for ($i = 0; $i < count($expectedBytes); $i++) {
            if (!isset($header[$i]) || ord($header[$i]) !== $expectedBytes[$i]) {
                return false;
            }
        }
        return true;
    }
    
    /**
     * ç—…æ¯’æ‰«æ
     */
    private static function virusScan($filepath)
    {
        // è¿™é‡Œå¯ä»¥é›†æˆç¬¬ä¸‰æ–¹ç—…æ¯’æ‰«ææœåŠ¡
        // ç¤ºä¾‹ï¼šä½¿ç”¨ClamAV
        /*
        $output = shell_exec("clamscan --no-summary {$filepath}");
        return strpos($output, 'FOUND') === false;
        */
        
        return true; // é»˜è®¤é€šè¿‡
    }
    
    /**
     * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
     */
    private static function formatFileSize($size)
    {
        $units = ['B', 'KB', 'MB', 'GB'];
        $index = 0;
        
        while ($size >= 1024 && $index < count($units) - 1) {
            $size /= 1024;
            $index++;
        }
        
        return round($size, 2) . ' ' . $units[$index];
    }
    
    /**
     * ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
     */
    public static function generateSecureFilename($originalName, $extension)
    {
        // ç”Ÿæˆéšæœºæ–‡ä»¶åï¼Œé¿å…æ–‡ä»¶åå†²çªå’Œè·¯å¾„éå†
        $filename = date('Ymd') . '/' . uniqid() . '.' . $extension;
        
        // ç¡®ä¿ç›®å½•å­˜åœ¨
        $dir = dirname($filename);
        if (!is_dir($dir)) {
            mkdir($dir, 0755, true);
        }
        
        return $filename;
    }
}
```

---

## ğŸ”’ æƒé™æ§åˆ¶å®‰å…¨

### RBACæƒé™æ¨¡å‹
```php
/**
 * åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶
 */
class RBACAuth
{
    /**
     * æ£€æŸ¥ç”¨æˆ·æƒé™
     */
    public static function checkPermission($userId, $permission)
    {
        // 1. è¶…çº§ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™
        if (self::isSuperAdmin($userId)) {
            return true;
        }
        
        // 2. è·å–ç”¨æˆ·è§’è‰²
        $userRoles = self::getUserRoles($userId);
        if (empty($userRoles)) {
            return false;
        }
        
        // 3. æ£€æŸ¥è§’è‰²æƒé™
        foreach ($userRoles as $role) {
            if (self::roleHasPermission($role['id'], $permission)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * æ£€æŸ¥æ•°æ®æƒé™
     */
    public static function checkDataPermission($userId, $dataOwnerId, $permission)
    {
        // 1. è¶…çº§ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰æ•°æ®
        if (self::isSuperAdmin($userId)) {
            return true;
        }
        
        // 2. æ£€æŸ¥æ˜¯å¦æ˜¯æ•°æ®æ‰€æœ‰è€…
        if ($userId == $dataOwnerId) {
            return self::checkPermission($userId, $permission);
        }
        
        // 3. æ£€æŸ¥æ˜¯å¦æœ‰ç®¡ç†ä¸‹çº§æ•°æ®çš„æƒé™
        if (self::canManageSubordinate($userId, $dataOwnerId)) {
            return self::checkPermission($userId, $permission);
        }
        
        return false;
    }
    
    /**
     * è·å–ç”¨æˆ·æ•°æ®æƒé™èŒƒå›´
     */
    public static function getDataScope($userId)
    {
        if (self::isSuperAdmin($userId)) {
            return ['type' => 'all'];
        }
        
        $userRoles = self::getUserRoles($userId);
        $dataScope = ['type' => 'self', 'user_ids' => [$userId]];
        
        foreach ($userRoles as $role) {
            switch ($role['data_scope']) {
                case 'all':
                    return ['type' => 'all'];
                    
                case 'dept':
                    $deptUsers = self::getDepartmentUsers($userId);
                    $dataScope['user_ids'] = array_merge($dataScope['user_ids'], $deptUsers);
                    $dataScope['type'] = 'dept';
                    break;
                    
                case 'dept_and_sub':
                    $deptAndSubUsers = self::getDepartmentAndSubUsers($userId);
                    $dataScope['user_ids'] = array_merge($dataScope['user_ids'], $deptAndSubUsers);
                    $dataScope['type'] = 'dept_and_sub';
                    break;
            }
        }
        
        return $dataScope;
    }
    
    /**
     * æƒé™ç¼“å­˜
     */
    public static function getCachedPermissions($userId)
    {
        $cacheKey = 'user_permissions_' . $userId;
        $permissions = cache($cacheKey);
        
        if ($permissions === false) {
            $permissions = self::loadUserPermissions($userId);
            cache($cacheKey, $permissions, 3600); // ç¼“å­˜1å°æ—¶
        }
        
        return $permissions;
    }
    
    /**
     * æ¸…é™¤æƒé™ç¼“å­˜
     */
    public static function clearPermissionCache($userId)
    {
        cache('user_permissions_' . $userId, null);
    }
    
    private static function isSuperAdmin($userId)
    {
        return \app\admin\model\Admin::where('id', $userId)->value('is_super') == 1;
    }
    
    private static function getUserRoles($userId)
    {
        return \think\Db::name('auth_group_access')
            ->alias('aga')
            ->join('auth_group ag', 'aga.group_id = ag.id')
            ->where('aga.uid', $userId)
            ->where('ag.status', 'normal')
            ->field('ag.*')
            ->select();
    }
    
    private static function roleHasPermission($roleId, $permission)
    {
        $rules = \think\Db::name('auth_group')->where('id', $roleId)->value('rules');
        $ruleIds = explode(',', $rules);
        
        return \think\Db::name('auth_rule')
            ->where('id', 'in', $ruleIds)
            ->where('name', $permission)
            ->where('status', 'normal')
            ->count() > 0;
    }
}
```

### APIæ¥å£æƒé™æ§åˆ¶
```php
/**
 * APIæ¥å£æƒé™ä¸­é—´ä»¶
 */
class ApiAuthMiddleware
{
    public function handle($request, \Closure $next)
    {
        // 1. è·å–Token
        $token = $this->getTokenFromRequest($request);
        if (!$token) {
            return $this->unauthorizedResponse('Tokenç¼ºå¤±');
        }
        
        // 2. éªŒè¯Token
        $payload = TokenSecurity::verifyToken($token);
        if (!$payload) {
            return $this->unauthorizedResponse('Tokenæ— æ•ˆ');
        }
        
        // 3. æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
        $user = \app\common\model\User::find($payload['user_id']);
        if (!$user || $user->status !== 'normal') {
            return $this->unauthorizedResponse('ç”¨æˆ·çŠ¶æ€å¼‚å¸¸');
        }
        
        // 4. æ£€æŸ¥æ¥å£æƒé™
        $controller = $request->controller();
        $action = $request->action();
        $permission = strtolower($controller . '/' . $action);
        
        if (!RBACAuth::checkPermission($user->id, $permission)) {
            return $this->forbiddenResponse('æ— æƒé™è®¿é—®');
        }
        
        // 5. è®°å½•è®¿é—®æ—¥å¿—
        $this->logApiAccess($user->id, $permission, $request->ip());
        
        // 6. å°†ç”¨æˆ·ä¿¡æ¯æ³¨å…¥è¯·æ±‚
        $request->user = $user;
        
        return $next($request);
    }
    
    private function getTokenFromRequest($request)
    {
        // ä»Headerè·å–
        $header = $request->header('Authorization');
        if ($header && strpos($header, 'Bearer ') === 0) {
            return substr($header, 7);
        }
        
        // ä»å‚æ•°è·å–
        return $request->param('token');
    }
    
    private function unauthorizedResponse($message)
    {
        return json(['code' => 401, 'msg' => $message, 'data' => null]);
    }
    
    private function forbiddenResponse($message)
    {
        return json(['code' => 403, 'msg' => $message, 'data' => null]);
    }
    
    private function logApiAccess($userId, $permission, $ip)
    {
        \think\Db::name('api_access_log')->insert([
            'user_id' => $userId,
            'permission' => $permission,
            'ip' => $ip,
            'create_time' => time()
        ]);
    }
}
```

---

## ğŸ›¡ï¸ æ•°æ®å®‰å…¨ä¿æŠ¤

### æ•æ„Ÿæ•°æ®åŠ å¯†
```php
/**
 * æ•æ„Ÿæ•°æ®åŠ å¯†å¤„ç†
 */
class DataEncryption
{
    private static $key;
    
    public static function init()
    {
        self::$key = config('app.encryption_key') ?: config('app.app_key');
    }
    
    /**
     * åŠ å¯†æ•æ„Ÿæ•°æ®
     */
    public static function encrypt($data)
    {
        if (empty($data)) {
            return $data;
        }
        
        self::init();
        
        $iv = openssl_random_pseudo_bytes(16);
        $encrypted = openssl_encrypt($data, 'AES-256-CBC', self::$key, 0, $iv);
        
        return base64_encode($iv . $encrypted);
    }
    
    /**
     * è§£å¯†æ•æ„Ÿæ•°æ®
     */
    public static function decrypt($encryptedData)
    {
        if (empty($encryptedData)) {
            return $encryptedData;
        }
        
        self::init();
        
        $data = base64_decode($encryptedData);
        $iv = substr($data, 0, 16);
        $encrypted = substr($data, 16);
        
        return openssl_decrypt($encrypted, 'AES-256-CBC', self::$key, 0, $iv);
    }
    
    /**
     * æ‰‹æœºå·è„±æ•
     */
    public static function maskMobile($mobile)
    {
        if (strlen($mobile) !== 11) {
            return $mobile;
        }
        
        return substr($mobile, 0, 3) . '****' . substr($mobile, -4);
    }
    
    /**
     * èº«ä»½è¯å·è„±æ•
     */
    public static function maskIdCard($idCard)
    {
        $length = strlen($idCard);
        if ($length < 8) {
            return $idCard;
        }
        
        return substr($idCard, 0, 4) . str_repeat('*', $length - 8) . substr($idCard, -4);
    }
    
    /**
     * é‚®ç®±è„±æ•
     */
    public static function maskEmail($email)
    {
        if (strpos($email, '@') === false) {
            return $email;
        }
        
        list($username, $domain) = explode('@', $email);
        $usernameLength = strlen($username);
        
        if ($usernameLength <= 2) {
            return $email;
        }
        
        $maskedUsername = substr($username, 0, 1) . str_repeat('*', $usernameLength - 2) . substr($username, -1);
        
        return $maskedUsername . '@' . $domain;
    }
}
```

### æ•°æ®åº“å®‰å…¨æ“ä½œ
```php
/**
 * æ•°æ®åº“å®‰å…¨æ“ä½œ
 */
class DatabaseSecurity
{
    /**
     * å®‰å…¨çš„æ•°æ®åº“æŸ¥è¯¢
     */
    public static function secureQuery($sql, $params = [])
    {
        // 1. æ£€æŸ¥SQLè¯­å¥æ˜¯å¦åŒ…å«å±é™©æ“ä½œ
        if (self::containsDangerousSQL($sql)) {
            \think\Log::warning('Dangerous SQL detected: ' . $sql);
            throw new \Exception('éæ³•SQLæ“ä½œ');
        }
        
        // 2. ä½¿ç”¨å‚æ•°ç»‘å®šé˜²æ­¢SQLæ³¨å…¥
        return \think\Db::query($sql, $params);
    }
    
    /**
     * æ£€æŸ¥æ˜¯å¦åŒ…å«å±é™©SQL
     */
    private static function containsDangerousSQL($sql)
    {
        $dangerousKeywords = [
            'DROP\s+TABLE',
            'DROP\s+DATABASE',
            'TRUNCATE\s+TABLE',
            'DELETE\s+FROM\s+\w+\s*;',
            'UPDATE\s+\w+\s+SET\s+.*\s*;',
            'EXEC\s*\(',
            'EXECUTE\s*\(',
            'xp_cmdshell',
            'sp_executesql'
        ];
        
        foreach ($dangerousKeywords as $keyword) {
            if (preg_match('/' . $keyword . '/i', $sql)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * æ•°æ®åº“è¿æ¥å®‰å…¨é…ç½®
     */
    public static function getSecureDbConfig()
    {
        return [
            // ä½¿ç”¨åªè¯»è´¦å·è¿›è¡ŒæŸ¥è¯¢æ“ä½œ
            'read_config' => [
                'username' => env('DB_READ_USERNAME'),
                'password' => env('DB_READ_PASSWORD'),
                'options' => [
                    \PDO::ATTR_EMULATE_PREPARES => false,
                    \PDO::ATTR_STRINGIFY_FETCHES => false,
                ]
            ],
            
            // ä½¿ç”¨è¯»å†™è´¦å·è¿›è¡Œå†™æ“ä½œ
            'write_config' => [
                'username' => env('DB_WRITE_USERNAME'),
                'password' => env('DB_WRITE_PASSWORD'),
                'options' => [
                    \PDO::ATTR_EMULATE_PREPARES => false,
                    \PDO::ATTR_STRINGIFY_FETCHES => false,
                ]
            ]
        ];
    }
    
    /**
     * æ•°æ®å¤‡ä»½
     */
    public static function backupData($tables = [])
    {
        $backupDir = ROOT_PATH . 'backup/' . date('Y-m-d');
        if (!is_dir($backupDir)) {
            mkdir($backupDir, 0755, true);
        }
        
        $filename = $backupDir . '/backup_' . date('His') . '.sql';
        
        // ä½¿ç”¨mysqldumpè¿›è¡Œå¤‡ä»½
        $command = sprintf(
            'mysqldump -h%s -u%s -p%s %s %s > %s',
            config('database.hostname'),
            config('database.username'),
            config('database.password'),
            config('database.database'),
            implode(' ', $tables),
            $filename
        );
        
        exec($command, $output, $returnCode);
        
        if ($returnCode === 0) {
            // å‹ç¼©å¤‡ä»½æ–‡ä»¶
            $zipFilename = $filename . '.zip';
            $zip = new \ZipArchive();
            if ($zip->open($zipFilename, \ZipArchive::CREATE) === TRUE) {
                $zip->addFile($filename, basename($filename));
                $zip->close();
                unlink($filename); // åˆ é™¤åŸå§‹SQLæ–‡ä»¶
                return $zipFilename;
            }
        }
        
        return false;
    }
}
```

---

## ğŸš¨ å®‰å…¨ç›‘æ§ä¸æ—¥å¿—

### å®‰å…¨äº‹ä»¶ç›‘æ§
```php
/**
 * å®‰å…¨äº‹ä»¶ç›‘æ§
 */
class SecurityMonitor
{
    /**
     * è®°å½•å®‰å…¨äº‹ä»¶
     */
    public static function logSecurityEvent($type, $description, $level = 'info', $userId = 0)
    {
        $data = [
            'type' => $type,
            'description' => $description,
            'level' => $level,
            'user_id' => $userId,
            'ip' => request()->ip(),
            'user_agent' => request()->header('User-Agent'),
            'url' => request()->url(),
            'create_time' => time()
        ];
        
        \think\Db::name('security_log')->insert($data);
        
        // é«˜å±äº‹ä»¶å®æ—¶å‘Šè­¦
        if (in_array($level, ['warning', 'error', 'critical'])) {
            self::sendAlert($data);
        }
    }
    
    /**
     * æ£€æµ‹å¼‚å¸¸ç™»å½•
     */
    public static function detectAbnormalLogin($userId, $ip, $userAgent)
    {
        // 1. æ£€æŸ¥IPåœ°å€æ˜¯å¦å¼‚å¸¸
        $lastLogin = \think\Db::name('admin_log')
            ->where('user_id', $userId)
            ->where('title', 'ç™»å½•')
            ->order('id desc')
            ->find();
            
        if ($lastLogin && $lastLogin['ip'] !== $ip) {
            // IPåœ°å€å˜æ›´ï¼Œè®°å½•å®‰å…¨äº‹ä»¶
            self::logSecurityEvent(
                'abnormal_login',
                "ç”¨æˆ·{$userId}ä»æ–°IPåœ°å€{$ip}ç™»å½•ï¼Œä¸Šæ¬¡ç™»å½•IPï¼š{$lastLogin['ip']}",
                'warning',
                $userId
            );
        }
        
        // 2. æ£€æŸ¥ç™»å½•æ—¶é—´æ˜¯å¦å¼‚å¸¸
        $currentHour = date('H');
        if ($currentHour < 6 || $currentHour > 22) {
            self::logSecurityEvent(
                'off_hours_login',
                "ç”¨æˆ·{$userId}åœ¨éå·¥ä½œæ—¶é—´{$currentHour}ç‚¹ç™»å½•",
                'info',
                $userId
            );
        }
        
        // 3. æ£€æŸ¥User-Agentæ˜¯å¦å¼‚å¸¸
        if (strpos($userAgent, 'curl') !== false || strpos($userAgent, 'wget') !== false) {
            self::logSecurityEvent(
                'suspicious_user_agent',
                "ç”¨æˆ·{$userId}ä½¿ç”¨å¯ç–‘User-Agentç™»å½•ï¼š{$userAgent}",
                'warning',
                $userId
            );
        }
    }
    
    /**
     * æ£€æµ‹æš´åŠ›ç ´è§£æ”»å‡»
     */
    public static function detectBruteForce($ip)
    {
        $attempts = cache('login_attempts_' . $ip) ?: 0;
        
        if ($attempts >= 10) {
            self::logSecurityEvent(
                'brute_force',
                "IPåœ°å€{$ip}ç–‘ä¼¼è¿›è¡Œæš´åŠ›ç ´è§£æ”»å‡»ï¼Œå¤±è´¥æ¬¡æ•°ï¼š{$attempts}",
                'critical'
            );
            
            // åŠ å…¥é»‘åå•
            self::addToBlacklist($ip, 'brute_force', 3600); // 1å°æ—¶
        }
    }
    
    /**
     * æ£€æµ‹SQLæ³¨å…¥æ”»å‡»
     */
    public static function detectSQLInjection($input, $ip)
    {
        $patterns = [
            '/union\s+select/i',
            '/or\s+1\s*=\s*1/i',
            '/and\s+1\s*=\s*1/i',
            '/drop\s+table/i',
            '/exec\s*\(/i',
            '/<script/i',
            '/javascript:/i'
        ];
        
        foreach ($patterns as $pattern) {
            if (preg_match($pattern, $input)) {
                self::logSecurityEvent(
                    'sql_injection',
                    "æ£€æµ‹åˆ°SQLæ³¨å…¥æ”»å‡»ï¼ŒIPï¼š{$ip}ï¼Œè¾“å…¥ï¼š" . substr($input, 0, 200),
                    'critical'
                );
                
                // åŠ å…¥é»‘åå•
                self::addToBlacklist($ip, 'sql_injection', 7200); // 2å°æ—¶
                break;
            }
        }
    }
    
    /**
     * æ·»åŠ åˆ°é»‘åå•
     */
    public static function addToBlacklist($ip, $reason, $duration = 3600)
    {
        $data = [
            'ip' => $ip,
            'reason' => $reason,
            'expire_time' => time() + $duration,
            'create_time' => time()
        ];
        
        \think\Db::name('ip_blacklist')->insert($data);
        
        // ç¼“å­˜é»‘åå•
        cache('blacklist_' . $ip, true, $duration);
    }
    
    /**
     * æ£€æŸ¥IPæ˜¯å¦åœ¨é»‘åå•ä¸­
     */
    public static function isBlacklisted($ip)
    {
        // å…ˆæ£€æŸ¥ç¼“å­˜
        if (cache('blacklist_' . $ip)) {
            return true;
        }
        
        // æ£€æŸ¥æ•°æ®åº“
        $blacklist = \think\Db::name('ip_blacklist')
            ->where('ip', $ip)
            ->where('expire_time', '>', time())
            ->find();
            
        if ($blacklist) {
            // æ›´æ–°ç¼“å­˜
            cache('blacklist_' . $ip, true, $blacklist['expire_time'] - time());
            return true;
        }
        
        return false;
    }
    
    /**
     * å‘é€å®‰å…¨å‘Šè­¦
     */
    private static function sendAlert($event)
    {
        // å‘é€é‚®ä»¶å‘Šè­¦
        $to = config('security.alert_email');
        if ($to) {
            $subject = 'å®‰å…¨å‘Šè­¦ï¼š' . $event['type'];
            $body = "å®‰å…¨äº‹ä»¶è¯¦æƒ…ï¼š\n";
            $body .= "ç±»å‹ï¼š{$event['type']}\n";
            $body .= "æè¿°ï¼š{$event['description']}\n";
            $body .= "ç­‰çº§ï¼š{$event['level']}\n";
            $body .= "IPåœ°å€ï¼š{$event['ip']}\n";
            $body .= "æ—¶é—´ï¼š" . date('Y-m-d H:i:s', $event['create_time']) . "\n";
            
            // è¿™é‡Œè°ƒç”¨é‚®ä»¶å‘é€æœåŠ¡
            // \app\common\library\Email::send($to, $subject, $body);
        }
        
        // å‘é€çŸ­ä¿¡å‘Šè­¦ï¼ˆé«˜å±äº‹ä»¶ï¼‰
        if ($event['level'] === 'critical') {
            $mobile = config('security.alert_mobile');
            if ($mobile) {
                $message = "å®‰å…¨å‘Šè­¦ï¼šæ£€æµ‹åˆ°{$event['type']}ï¼Œè¯·åŠæ—¶å¤„ç†ã€‚æ—¶é—´ï¼š" . date('m-d H:i');
                // è¿™é‡Œè°ƒç”¨çŸ­ä¿¡å‘é€æœåŠ¡
                // \app\common\library\Sms::send($mobile, $message);
            }
        }
    }
}
```

---

## ğŸ“‹ å®‰å…¨æ£€æŸ¥æ¸…å•

### ä»£ç å®‰å…¨æ£€æŸ¥
- [ ] æ‰€æœ‰ç”¨æˆ·è¾“å…¥éƒ½ç»è¿‡éªŒè¯å’Œè¿‡æ»¤
- [ ] ä½¿ç”¨å‚æ•°ç»‘å®šé˜²æ­¢SQLæ³¨å…¥
- [ ] å®ç°XSSé˜²æŠ¤æªæ–½
- [ ] æ–‡ä»¶ä¸Šä¼ å®‰å…¨éªŒè¯
- [ ] å¯†ç ä½¿ç”¨å¼ºåŠ å¯†ç®—æ³•
- [ ] Tokenä½¿ç”¨å®‰å…¨ç®—æ³•ç”Ÿæˆ
- [ ] æƒé™æ£€æŸ¥è¦†ç›–æ‰€æœ‰æ¥å£
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†å­˜å‚¨
- [ ] é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
- [ ] æ—¥å¿—è®°å½•å®‰å…¨äº‹ä»¶

### é…ç½®å®‰å…¨æ£€æŸ¥
- [ ] æ•°æ®åº“è¿æ¥ä½¿ç”¨æœ€å°æƒé™è´¦å·
- [ ] å…³é—­ä¸å¿…è¦çš„æœåŠ¡å’Œç«¯å£
- [ ] è®¾ç½®åˆç†çš„ä¼šè¯è¶…æ—¶æ—¶é—´
- [ ] é…ç½®HTTPSå¼ºåˆ¶è·³è½¬
- [ ] è®¾ç½®å®‰å…¨çš„Cookieå±æ€§
- [ ] é…ç½®é˜²ç«å¢™è§„åˆ™
- [ ] å®šæœŸæ›´æ–°ç³»ç»Ÿå’Œè½¯ä»¶
- [ ] è®¾ç½®æ–‡ä»¶ä¸Šä¼ ç›®å½•æƒé™
- [ ] éšè—æœåŠ¡å™¨ç‰ˆæœ¬ä¿¡æ¯
- [ ] é…ç½®è®¿é—®é¢‘ç‡é™åˆ¶

### è¿è¡Œæ—¶å®‰å…¨æ£€æŸ¥
- [ ] ç›‘æ§å¼‚å¸¸ç™»å½•è¡Œä¸º
- [ ] æ£€æµ‹æš´åŠ›ç ´è§£æ”»å‡»
- [ ] ç›‘æ§SQLæ³¨å…¥å°è¯•
- [ ] æ£€æŸ¥æ–‡ä»¶ä¸Šä¼ å®‰å…¨
- [ ] ç›‘æ§æƒé™è¶Šæƒè®¿é—®
- [ ] è®°å½•æ•æ„Ÿæ“ä½œæ—¥å¿—
- [ ] å®šæœŸå¤‡ä»½é‡è¦æ•°æ®
- [ ] æ£€æŸ¥ç³»ç»Ÿæ¼æ´
- [ ] ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨
- [ ] å®šæœŸæ¸…ç†ä¸´æ—¶æ–‡ä»¶

---

**æ³¨æ„**: å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦å®šæœŸè¯„ä¼°å’Œæ›´æ–°å®‰å…¨æªæ–½ã€‚å¼€å‘äººå‘˜åº”å…·å¤‡åŸºæœ¬çš„å®‰å…¨æ„è¯†ï¼Œéµå¾ªå®‰å…¨ç¼–ç è§„èŒƒã€‚