---
# ===========================================
# ğŸ¤– AIè‡ªåŠ¨è°ƒåº¦é…ç½® (å¿…éœ€)
# ===========================================
ruleName: "fastadmin-performance-optimization"
description: "FastAdminæ€§èƒ½ä¼˜åŒ–æ ‡å‡†è§„èŒƒï¼ŒåŒ…å«æ•°æ®åº“ä¼˜åŒ–ã€ç¼“å­˜ç­–ç•¥ã€å‰ç«¯ä¼˜åŒ–ç­‰æ€§èƒ½æå‡æŒ‡å¯¼"
version: "1.0.0"
lastUpdated: "2024-12-19"

alwaysApply: false
priority: 6

# ===========================================
# ğŸ” æ™ºèƒ½æ£€æµ‹é…ç½® (æ ¸å¿ƒ)
# ===========================================
detection:
  keywords:
    primary: ["æ€§èƒ½", "ä¼˜åŒ–", "performance", "ç¼“å­˜", "æ…¢æŸ¥è¯¢"]
    secondary: ["åŠ é€Ÿ", "æå‡", "å“åº”æ—¶é—´", "å¹¶å‘", "è´Ÿè½½"]
    technical: ["cache", "redis", "memcache", "ç´¢å¼•", "SQLä¼˜åŒ–", "CDN"]
  
  paths:
    exact: ["config/cache.php", "config/database.php"]
    pattern: ["**/cache/**", "**/optimize/**"]
  
  contexts:
    development_phase: ["æ€§èƒ½ä¼˜åŒ–", "ç³»ç»Ÿè°ƒä¼˜", "ç”Ÿäº§éƒ¨ç½²"]
    project_type: ["é«˜å¹¶å‘ç³»ç»Ÿ", "å¤§æ•°æ®å¤„ç†", "æ€§èƒ½æ•æ„Ÿåº”ç”¨"]
    user_intent: ["æ€§èƒ½æå‡", "é€Ÿåº¦ä¼˜åŒ–", "èµ„æºä¼˜åŒ–", "å¹¶å‘ä¼˜åŒ–"]

# ===========================================
# âš¡ è§¦å‘æ¡ä»¶é…ç½® (ç²¾ç¡®)
# ===========================================
triggers:
  explicit_mentions:
    exact_match: ["æ€§èƒ½", "ä¼˜åŒ–", "performance", "ç¼“å­˜", "æ…¢æŸ¥è¯¢", "åŠ é€Ÿ"]
    fuzzy_match: ["å“åº”æ…¢", "å¡é¡¿", "é€Ÿåº¦", "æ•ˆç‡", "å¹¶å‘"]
  
  file_operations:
    reading: ["ç¼“å­˜é…ç½®æ–‡ä»¶", "æ•°æ®åº“é…ç½®æ–‡ä»¶"]
    editing: ["æ€§èƒ½ç›¸å…³é…ç½®", "ç¼“å­˜ç­–ç•¥", "æ•°æ®åº“ä¼˜åŒ–"]
    creating: ["ç¼“å­˜æœºåˆ¶", "æ€§èƒ½ç›‘æ§", "ä¼˜åŒ–æ–¹æ¡ˆ"]
  
  code_patterns:
    namespaces: ["think\\cache", "think\\db"]
    functions: ["cache", "redis", "optimize", "index", "query"]
    classes: ["Cache", "Redis", "Database", "Performance"]
    comments: ["æ€§èƒ½", "ä¼˜åŒ–", "ç¼“å­˜", "ç´¢å¼•"]
  
  intent_analysis:
    primary_intent: ["performance_optimization", "system_tuning", "speed_improvement"]
    secondary_intent: ["cache_implementation", "database_optimization", "concurrent_handling"]
    complexity_level: ["medium", "complex"]

# ===========================================
# ğŸ”— å…³è”è§„åˆ™é…ç½®
# ===========================================
relationships:
  required_with: ["fastadmin-v5-standards.mdc"]
  recommended_with: ["thinkphp-v5-development-standards.mdc"]
  depends_on: ["common-rules.mdc"]

# ===========================================
# ğŸ“Š ä½¿ç”¨åœºæ™¯æè¿° (å¸®åŠ©AIç†è§£)
# ===========================================
use_cases:
  primary:
    - scenario: "ç”¨æˆ·é‡åˆ°ç³»ç»Ÿæ€§èƒ½é—®é¢˜éœ€è¦ä¼˜åŒ–"
      trigger_example: "FastAdminåå°å“åº”å¾ˆæ…¢ï¼Œå¦‚ä½•ä¼˜åŒ–ï¼Ÿ"
      expected_behavior: "AIåº”è¯¥æä¾›ç³»ç»Ÿæ€§çš„æ€§èƒ½è¯Šæ–­å’Œä¼˜åŒ–æ–¹æ¡ˆ"
    - scenario: "ç”¨æˆ·éœ€è¦å®ç°ç¼“å­˜æœºåˆ¶"
      trigger_example: "å¦‚ä½•ä¸ºFastAdminæ·»åŠ Redisç¼“å­˜ï¼Ÿ"
      expected_behavior: "AIåº”è¯¥æä¾›å®Œæ•´çš„ç¼“å­˜å®ç°æ–¹æ¡ˆå’Œé…ç½®æ–¹æ³•"
  
  secondary:
    - scenario: "ç”¨æˆ·è¦ä¼˜åŒ–æ•°æ®åº“æŸ¥è¯¢"
      trigger_example: "FastAdminçš„æ•°æ®è¡¨æŸ¥è¯¢å¤ªæ…¢æ€ä¹ˆåŠï¼Ÿ"
      expected_behavior: "AIåº”è¯¥æä¾›æ•°æ®åº“ä¼˜åŒ–å’Œç´¢å¼•å»ºè®®"
    - scenario: "ç”¨æˆ·éœ€è¦æå‡å¹¶å‘å¤„ç†èƒ½åŠ›"
      trigger_example: "å¦‚ä½•æé«˜FastAdminçš„å¹¶å‘è®¿é—®èƒ½åŠ›ï¼Ÿ"
      expected_behavior: "AIåº”è¯¥æä¾›å¹¶å‘ä¼˜åŒ–å’Œè´Ÿè½½å‡è¡¡å»ºè®®"

# ===========================================
# ğŸ¯ AIæŒ‡ä»¤é…ç½® (æ˜ç¡®æŒ‡å¯¼)
# ===========================================
ai_instructions:
  when_to_load: "å½“ç”¨æˆ·æåŠæ€§èƒ½ã€ä¼˜åŒ–ã€ç¼“å­˜ã€æ…¢æŸ¥è¯¢ã€å“åº”æ—¶é—´ç­‰å…³é”®è¯ï¼Œæˆ–é‡åˆ°æ€§èƒ½é—®é¢˜æ—¶åº”ç«‹å³åŠ è½½æ­¤è§„åˆ™"
  how_to_apply: "ç³»ç»Ÿæ€§åœ°åˆ†ææ€§èƒ½ç“¶é¢ˆï¼Œæä¾›é’ˆå¯¹æ€§çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œä¼˜å…ˆè€ƒè™‘æŠ•å…¥äº§å‡ºæ¯”é«˜çš„ä¼˜åŒ–æªæ–½"
  priority_reason: "æ€§èƒ½ä¼˜åŒ–ç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒå’Œç³»ç»Ÿç¨³å®šæ€§ï¼Œæ˜¯ç”Ÿäº§ç¯å¢ƒçš„é‡è¦è€ƒé‡"
  coordination: "ä¸FastAdminåŸºç¡€è§„èŒƒå’Œæ•°æ®åº“è§„èŒƒåè°ƒï¼Œç¡®ä¿ä¼˜åŒ–æªæ–½çš„å…¼å®¹æ€§å’Œæœ‰æ•ˆæ€§"

# ===========================================
# ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–é…ç½®
# ===========================================
performance:
  preload_conditions: ["æ£€æµ‹åˆ°æ€§èƒ½ç›¸å…³é—®é¢˜", "ç”¨æˆ·å†å²æ“ä½œæ¶‰åŠç³»ç»Ÿä¼˜åŒ–"]
  cache_duration: "30"
  unload_conditions: ["è¿ç»­4æ¬¡å¯¹è¯æœªæ¶‰åŠæ€§èƒ½ç›¸å…³å†…å®¹"]
---

# FastAdmin æ€§èƒ½ä¼˜åŒ–æ ‡å‡†è§„èŒƒ

> **ä¼˜åŒ–ç›®æ ‡**: æå‡ç³»ç»Ÿå“åº”é€Ÿåº¦ã€å‡å°‘èµ„æºæ¶ˆè€—ã€æé«˜å¹¶å‘èƒ½åŠ›
> **é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–ã€é«˜å¹¶å‘ç³»ç»Ÿã€å¤§æ•°æ®é‡å¤„ç†

---

## ğŸš€ æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–è§„èŒƒ
```php
/**
 * æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–æœ€ä½³å®è·µ
 */
class DatabaseOptimization
{
    /**
     * ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
     */
    public function optimizedQuery()
    {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨ç´¢å¼•å­—æ®µæŸ¥è¯¢
        $users = \think\Db::name('user')
            ->where('status', 'normal')          // statuså­—æ®µæœ‰ç´¢å¼•
            ->where('create_time', '>', $time)   // create_timeå­—æ®µæœ‰ç´¢å¼•
            ->limit(10)
            ->select();
        
        // âŒ é”™è¯¯ï¼šé¿å…åœ¨éç´¢å¼•å­—æ®µä½¿ç”¨LIKE
        $users = \think\Db::name('user')
            ->where('content', 'like', '%keyword%')  // contentå­—æ®µæ— ç´¢å¼•ä¸”å‰ç½®%
            ->select();
    }
    
    /**
     * åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
     */
    public function optimizedPagination($page, $limit)
    {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨LIMIT OFFSETä¼˜åŒ–
        $offset = ($page - 1) * $limit;
        
        // å¯¹äºå¤§æ•°æ®é‡ï¼Œä½¿ç”¨IDèŒƒå›´æŸ¥è¯¢
        if ($page > 100) {
            $lastId = \think\Db::name('user')
                ->order('id desc')
                ->limit($offset, 1)
                ->value('id');
                
            $users = \think\Db::name('user')
                ->where('id', '<', $lastId)
                ->order('id desc')
                ->limit($limit)
                ->select();
        } else {
            $users = \think\Db::name('user')
                ->order('id desc')
                ->limit($offset, $limit)
                ->select();
        }
        
        return $users;
    }
    
    /**
     * æ‰¹é‡æ“ä½œä¼˜åŒ–
     */
    public function batchOperations($data)
    {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥
        \think\Db::name('user')->insertAll($data);
        
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨æ‰¹é‡æ›´æ–°
        $cases = [];
        $ids = [];
        foreach ($data as $item) {
            $cases[] = "WHEN {$item['id']} THEN '{$item['status']}'";
            $ids[] = $item['id'];
        }
        
        $sql = "UPDATE user SET status = CASE id " . implode(' ', $cases) . " END WHERE id IN (" . implode(',', $ids) . ")";
        \think\Db::execute($sql);
    }
    
    /**
     * å…³è”æŸ¥è¯¢ä¼˜åŒ–
     */
    public function optimizedJoins()
    {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨é¢„åŠ è½½é¿å…N+1æŸ¥è¯¢
        $users = \app\admin\model\User::with(['profile', 'roles'])->select();
        
        // âœ… æ­£ç¡®ï¼šé™åˆ¶å…³è”æŸ¥è¯¢å­—æ®µ
        $users = \think\Db::name('user')
            ->alias('u')
            ->join('user_profile p', 'u.id = p.user_id', 'LEFT')
            ->field('u.id, u.username, p.nickname, p.avatar')
            ->where('u.status', 'normal')
            ->select();
    }
    
    /**
     * å­æŸ¥è¯¢ä¼˜åŒ–
     */
    public function optimizedSubqueries()
    {
        // âœ… æ­£ç¡®ï¼šä½¿ç”¨EXISTSæ›¿ä»£INå­æŸ¥è¯¢
        $users = \think\Db::name('user')
            ->alias('u')
            ->whereExists(function($query) {
                $query->name('user_role')
                    ->alias('ur')
                    ->where('ur.user_id = u.id')
                    ->where('ur.role_id', 1);
            })
            ->select();
    }
}
```

### ç´¢å¼•ä¼˜åŒ–ç­–ç•¥
```sql
-- å•åˆ—ç´¢å¼•
CREATE INDEX idx_user_status ON fa_user(status);
CREATE INDEX idx_user_create_time ON fa_user(create_time);
CREATE INDEX idx_user_email ON fa_user(email);

-- å¤åˆç´¢å¼•ï¼ˆæ³¨æ„å­—æ®µé¡ºåºï¼‰
CREATE INDEX idx_user_status_time ON fa_user(status, create_time);
CREATE INDEX idx_user_type_status ON fa_user(user_type, status, create_time);

-- å”¯ä¸€ç´¢å¼•
CREATE UNIQUE INDEX idx_user_username ON fa_user(username);
CREATE UNIQUE INDEX idx_user_email ON fa_user(email);

-- å‰ç¼€ç´¢å¼•ï¼ˆé€‚ç”¨äºé•¿å­—ç¬¦ä¸²ï¼‰
CREATE INDEX idx_user_content ON fa_user(content(20));

-- å‡½æ•°ç´¢å¼•ï¼ˆMySQL 8.0+ï¼‰
CREATE INDEX idx_user_upper_username ON fa_user((UPPER(username)));
```

### æ•°æ®åº“è¿æ¥ä¼˜åŒ–
```php
// config/database.php
return [
    'type'            => 'mysql',
    'hostname'        => '127.0.0.1',
    'database'        => 'fastadmin',
    'username'        => 'root',
    'password'        => '',
    'hostport'        => '3306',
    'params'          => [
        // å¯ç”¨æŒä¹…è¿æ¥
        \PDO::ATTR_PERSISTENT => true,
        // è®¾ç½®å­—ç¬¦é›†
        \PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8mb4",
        // ç¦ç”¨é¢„å¤„ç†è¯­å¥æ¨¡æ‹Ÿ
        \PDO::ATTR_EMULATE_PREPARES => false,
        // è®¾ç½®è¶…æ—¶æ—¶é—´
        \PDO::ATTR_TIMEOUT => 30,
    ],
    'charset'         => 'utf8mb4',
    'prefix'          => 'fa_',
    // å¯ç”¨è¯»å†™åˆ†ç¦»
    'rw_separate'     => true,
    'master_num'      => 1,
    'slave_no'        => '',
    // è¿æ¥æ± é…ç½®
    'pool'            => [
        'max_connections' => 20,
        'min_connections' => 5,
        'max_idle_time'   => 60,
        'wait_timeout'    => 10,
    ],
];
```

---

## ğŸ“¦ ç¼“å­˜ä¼˜åŒ–ç­–ç•¥

### Redisç¼“å­˜é…ç½®
```php
// config/cache.php
return [
    'default' => 'redis',
    'stores' => [
        'redis' => [
            'type'       => 'Redis',
            'host'       => '127.0.0.1',
            'port'       => 6379,
            'password'   => '',
            'select'     => 0,
            'timeout'    => 0,
            'expire'     => 0,
            'persistent' => true,
            'prefix'     => 'fastadmin:',
            'serialize'  => true,
            // Redisè¿æ¥æ± 
            'pool' => [
                'min_connections' => 5,
                'max_connections' => 50,
                'connect_timeout' => 10.0,
                'wait_timeout' => 3.0,
                'heartbeat' => -1,
                'max_idle_time' => 60.0,
            ],
        ],
        'file' => [
            'type'   => 'File',
            'path'   => '../runtime/cache/',
            'prefix' => '',
            'expire' => 0,
        ],
    ],
];
```

### å¤šå±‚ç¼“å­˜ç­–ç•¥
```php
/**
 * å¤šå±‚ç¼“å­˜å®ç°
 */
class MultiLevelCache
{
    private $l1Cache; // æœ¬åœ°ç¼“å­˜ï¼ˆAPCu/å†…å­˜ï¼‰
    private $l2Cache; // åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆRedisï¼‰
    private $l3Cache; // æ–‡ä»¶ç¼“å­˜
    
    public function __construct()
    {
        $this->l1Cache = new \think\cache\driver\File(['path' => '../runtime/cache/l1/']);
        $this->l2Cache = new \think\cache\driver\Redis();
        $this->l3Cache = new \think\cache\driver\File(['path' => '../runtime/cache/l3/']);
    }
    
    /**
     * è·å–ç¼“å­˜æ•°æ®
     */
    public function get($key)
    {
        // L1ç¼“å­˜ï¼ˆæœ€å¿«ï¼‰
        $data = $this->l1Cache->get($key);
        if ($data !== false) {
            return $data;
        }
        
        // L2ç¼“å­˜ï¼ˆRedisï¼‰
        $data = $this->l2Cache->get($key);
        if ($data !== false) {
            // å›å†™åˆ°L1ç¼“å­˜
            $this->l1Cache->set($key, $data, 300); // 5åˆ†é’Ÿ
            return $data;
        }
        
        // L3ç¼“å­˜ï¼ˆæ–‡ä»¶ï¼‰
        $data = $this->l3Cache->get($key);
        if ($data !== false) {
            // å›å†™åˆ°L2å’ŒL1ç¼“å­˜
            $this->l2Cache->set($key, $data, 3600); // 1å°æ—¶
            $this->l1Cache->set($key, $data, 300);  // 5åˆ†é’Ÿ
            return $data;
        }
        
        return false;
    }
    
    /**
     * è®¾ç½®ç¼“å­˜æ•°æ®
     */
    public function set($key, $value, $expire = 3600)
    {
        // å†™å…¥æ‰€æœ‰å±‚çº§ç¼“å­˜
        $this->l3Cache->set($key, $value, $expire);
        $this->l2Cache->set($key, $value, min($expire, 3600));
        $this->l1Cache->set($key, $value, min($expire, 300));
    }
    
    /**
     * åˆ é™¤ç¼“å­˜
     */
    public function delete($key)
    {
        $this->l1Cache->delete($key);
        $this->l2Cache->delete($key);
        $this->l3Cache->delete($key);
    }
}
```

### ç¼“å­˜ç­–ç•¥å®ç°
```php
/**
 * æ™ºèƒ½ç¼“å­˜ç­–ç•¥
 */
class CacheStrategy
{
    /**
     * çƒ­ç‚¹æ•°æ®ç¼“å­˜
     */
    public static function getHotData($key, $callback, $expire = 3600)
    {
        $cacheKey = 'hot_data:' . $key;
        $data = cache($cacheKey);
        
        if ($data === false) {
            // ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢ç¼“å­˜å‡»ç©¿
            $lockKey = 'lock:' . $cacheKey;
            $lockValue = uniqid();
            
            if (self::acquireLock($lockKey, $lockValue, 30)) {
                try {
                    // åŒé‡æ£€æŸ¥
                    $data = cache($cacheKey);
                    if ($data === false) {
                        $data = call_user_func($callback);
                        // è®¾ç½®éšæœºè¿‡æœŸæ—¶é—´é˜²æ­¢ç¼“å­˜é›ªå´©
                        $randomExpire = $expire + mt_rand(0, 300);
                        cache($cacheKey, $data, $randomExpire);
                    }
                } finally {
                    self::releaseLock($lockKey, $lockValue);
                }
            } else {
                // è·å–é”å¤±è´¥ï¼Œè¿”å›æ—§æ•°æ®æˆ–ç­‰å¾…
                usleep(100000); // ç­‰å¾…100ms
                $data = cache($cacheKey);
                if ($data === false) {
                    $data = call_user_func($callback);
                }
            }
        }
        
        return $data;
    }
    
    /**
     * åˆ†é¡µæ•°æ®ç¼“å­˜
     */
    public static function getPaginatedData($model, $page, $limit, $where = [], $order = 'id desc')
    {
        $cacheKey = 'paginated:' . md5(serialize([$model, $page, $limit, $where, $order]));
        
        return cache($cacheKey, function() use ($model, $page, $limit, $where, $order) {
            $query = \think\Db::name($model);
            
            if (!empty($where)) {
                $query->where($where);
            }
            
            $total = $query->count();
            $list = $query->order($order)
                         ->page($page, $limit)
                         ->select();
            
            return [
                'total' => $total,
                'list' => $list,
                'page' => $page,
                'limit' => $limit
            ];
        }, 600); // 10åˆ†é’Ÿç¼“å­˜
    }
    
    /**
     * è·å–åˆ†å¸ƒå¼é”
     */
    private static function acquireLock($key, $value, $expire)
    {
        $redis = \think\Cache::store('redis')->handler();
        return $redis->set($key, $value, ['nx', 'ex' => $expire]);
    }
    
    /**
     * é‡Šæ”¾åˆ†å¸ƒå¼é”
     */
    private static function releaseLock($key, $value)
    {
        $redis = \think\Cache::store('redis')->handler();
        $script = "
            if redis.call('get', KEYS[1]) == ARGV[1] then
                return redis.call('del', KEYS[1])
            else
                return 0
            end
        ";
        return $redis->eval($script, [$key, $value], 1);
    }
}
```

---

## âš¡ å‰ç«¯æ€§èƒ½ä¼˜åŒ–

### JavaScriptä¼˜åŒ–
```javascript
/**
 * JavaScriptæ€§èƒ½ä¼˜åŒ–
 */
define(['jquery'], function($) {
    
    var PerformanceOptimizer = {
        
        /**
         * é˜²æŠ–å‡½æ•°
         */
        debounce: function(func, wait, immediate) {
            var timeout;
            return function() {
                var context = this, args = arguments;
                var later = function() {
                    timeout = null;
                    if (!immediate) func.apply(context, args);
                };
                var callNow = immediate && !timeout;
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
                if (callNow) func.apply(context, args);
            };
        },
        
        /**
         * èŠ‚æµå‡½æ•°
         */
        throttle: function(func, wait) {
            var timeout;
            var previous = 0;
            return function() {
                var now = Date.now();
                var context = this;
                var args = arguments;
                if (now - previous > wait) {
                    if (timeout) {
                        clearTimeout(timeout);
                        timeout = null;
                    }
                    func.apply(context, args);
                    previous = now;
                } else if (!timeout) {
                    timeout = setTimeout(function() {
                        timeout = null;
                        func.apply(context, args);
                        previous = Date.now();
                    }, wait - (now - previous));
                }
            };
        },
        
        /**
         * è™šæ‹Ÿæ»šåŠ¨å®ç°
         */
        virtualScroll: function(container, data, itemHeight, visibleCount) {
            var $container = $(container);
            var $viewport = $('<div class="virtual-viewport"></div>');
            var $content = $('<div class="virtual-content"></div>');
            
            $container.append($viewport);
            $viewport.append($content);
            
            var totalHeight = data.length * itemHeight;
            var startIndex = 0;
            var endIndex = Math.min(visibleCount, data.length);
            
            // è®¾ç½®å®¹å™¨é«˜åº¦
            $viewport.height(totalHeight);
            
            var renderItems = function() {
                var scrollTop = $container.scrollTop();
                startIndex = Math.floor(scrollTop / itemHeight);
                endIndex = Math.min(startIndex + visibleCount + 5, data.length);
                
                var html = '';
                for (var i = startIndex; i < endIndex; i++) {
                    html += '<div class="virtual-item" style="height:' + itemHeight + 'px;transform:translateY(' + (i * itemHeight) + 'px)">';
                    html += data[i];
                    html += '</div>';
                }
                
                $content.html(html);
            };
            
            // ç›‘å¬æ»šåŠ¨äº‹ä»¶
            $container.on('scroll', this.throttle(renderItems, 16));
            
            // åˆå§‹æ¸²æŸ“
            renderItems();
        },
        
        /**
         * å›¾ç‰‡æ‡’åŠ è½½
         */
        lazyLoadImages: function(selector) {
            var $images = $(selector || 'img[data-src]');
            
            var observer = new IntersectionObserver(function(entries) {
                entries.forEach(function(entry) {
                    if (entry.isIntersecting) {
                        var img = entry.target;
                        img.src = img.dataset.src;
                        img.classList.add('loaded');
                        observer.unobserve(img);
                    }
                });
            }, {
                rootMargin: '50px'
            });
            
            $images.each(function() {
                observer.observe(this);
            });
        },
        
        /**
         * AJAXè¯·æ±‚ä¼˜åŒ–
         */
        optimizedAjax: function(options) {
            var defaults = {
                timeout: 10000,
                cache: false,
                beforeSend: function() {
                    // æ˜¾ç¤ºloading
                    $('.loading').show();
                },
                complete: function() {
                    // éšè—loading
                    $('.loading').hide();
                },
                error: function(xhr, status, error) {
                    if (status === 'timeout') {
                        console.error('è¯·æ±‚è¶…æ—¶');
                    } else {
                        console.error('è¯·æ±‚å¤±è´¥:', error);
                    }
                }
            };
            
            return $.ajax($.extend({}, defaults, options));
        },
        
        /**
         * å†…å­˜æ³„æ¼é˜²æŠ¤
         */
        preventMemoryLeaks: function() {
            // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            $(window).off('.performance');
            $(document).off('.performance');
            
            // æ¸…ç†å®šæ—¶å™¨
            if (window.performanceTimers) {
                window.performanceTimers.forEach(function(timer) {
                    clearTimeout(timer);
                    clearInterval(timer);
                });
                window.performanceTimers = [];
            }
            
            // æ¸…ç†å…¨å±€å˜é‡
            if (window.performanceCache) {
                window.performanceCache = null;
            }
        }
    };
    
    return PerformanceOptimizer;
});
```

### CSSä¼˜åŒ–ç­–ç•¥
```css
/* å…³é”®CSSå†…è” */
.critical-css {
    /* é¦–å±å¿…éœ€çš„æ ·å¼ */
    display: block;
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
}

/* ä½¿ç”¨CSS3ç¡¬ä»¶åŠ é€Ÿ */
.gpu-accelerated {
    transform: translateZ(0);
    backface-visibility: hidden;
    perspective: 1000px;
}

/* ä¼˜åŒ–åŠ¨ç”»æ€§èƒ½ */
.smooth-animation {
    will-change: transform;
    transition: transform 0.3s ease-out;
}

/* é¿å…é‡æ’é‡ç»˜ */
.avoid-reflow {
    position: absolute;
    top: 0;
    left: 0;
    transform: translate3d(100px, 100px, 0);
}

/* ä½¿ç”¨Flexboxæ›¿ä»£Float */
.flex-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* ä¼˜åŒ–å­—ä½“åŠ è½½ */
@font-face {
    font-family: 'CustomFont';
    src: url('font.woff2') format('woff2'),
         url('font.woff') format('woff');
    font-display: swap;
}

/* å“åº”å¼å›¾ç‰‡ */
.responsive-image {
    max-width: 100%;
    height: auto;
    object-fit: cover;
}

/* ä½¿ç”¨CSS Gridè¿›è¡Œå¸ƒå±€ */
.grid-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}
```

### èµ„æºåŠ è½½ä¼˜åŒ–
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- DNSé¢„è§£æ -->
    <link rel="dns-prefetch" href="//cdn.example.com">
    <link rel="dns-prefetch" href="//api.example.com">
    
    <!-- é¢„è¿æ¥ -->
    <link rel="preconnect" href="//fonts.googleapis.com" crossorigin>
    
    <!-- å…³é”®èµ„æºé¢„åŠ è½½ -->
    <link rel="preload" href="/assets/css/critical.css" as="style">
    <link rel="preload" href="/assets/js/critical.js" as="script">
    <link rel="preload" href="/assets/fonts/main.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- å…³é”®CSSå†…è” */
    <style>
        /* å…³é”®æ ·å¼ */
        body { margin: 0; padding: 0; }
        .header { height: 60px; background: #333; }
    </style>
    
    <!-- éå…³é”®CSSå¼‚æ­¥åŠ è½½ -->
    <link rel="preload" href="/assets/css/non-critical.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/assets/css/non-critical.css"></noscript>
</head>
<body>
    <!-- é¡µé¢å†…å®¹ -->
    
    <!-- JavaScriptå»¶è¿ŸåŠ è½½ -->
    <script>
        // é¡µé¢åŠ è½½å®Œæˆåå†åŠ è½½éå…³é”®JavaScript
        window.addEventListener('load', function() {
            var scripts = [
                '/assets/js/vendor.js',
                '/assets/js/app.js'
            ];
            
            scripts.forEach(function(src) {
                var script = document.createElement('script');
                script.src = src;
                script.async = true;
                document.head.appendChild(script);
            });
        });
    </script>
</body>
</html>
```

---

## ğŸ”§ æœåŠ¡å™¨æ€§èƒ½ä¼˜åŒ–

### PHPé…ç½®ä¼˜åŒ–
```ini
; php.ini æ€§èƒ½ä¼˜åŒ–é…ç½®

; å†…å­˜é™åˆ¶
memory_limit = 256M

; æ‰§è¡Œæ—¶é—´é™åˆ¶
max_execution_time = 30
max_input_time = 60

; æ–‡ä»¶ä¸Šä¼ 
upload_max_filesize = 20M
post_max_size = 25M
max_file_uploads = 20

; ä¼šè¯é…ç½®
session.gc_maxlifetime = 1440
session.gc_probability = 1
session.gc_divisor = 1000

; OPcacheé…ç½®
opcache.enable = 1
opcache.enable_cli = 0
opcache.memory_consumption = 128
opcache.interned_strings_buffer = 8
opcache.max_accelerated_files = 4000
opcache.revalidate_freq = 2
opcache.fast_shutdown = 1
opcache.enable_file_override = 1

; å®æ—¶ç¼–è¯‘ä¼˜åŒ–
opcache.optimization_level = 0x7FFFBFFF
opcache.dups_fix = 1
opcache.blacklist_filename = /path/to/opcache-blacklist.txt
```

### Nginxé…ç½®ä¼˜åŒ–
```nginx
# nginx.conf æ€§èƒ½ä¼˜åŒ–é…ç½®

# å·¥ä½œè¿›ç¨‹æ•°
worker_processes auto;

# æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
events {
    worker_connections 2048;
    use epoll;
    multi_accept on;
}

http {
    # éšè—ç‰ˆæœ¬ä¿¡æ¯
    server_tokens off;
    
    # æ–‡ä»¶æè¿°ç¬¦ç¼“å­˜
    open_file_cache max=200000 inactive=20s;
    open_file_cache_valid 30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors on;
    
    # Gzipå‹ç¼©
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/xml
        text/javascript
        application/json
        application/javascript
        application/xml+rss
        application/atom+xml
        image/svg+xml;
    
    # ç¼“å­˜é…ç½®
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # PHP-FPMé…ç½®
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # FastCGIç¼“å­˜
        fastcgi_cache_valid 200 302 10m;
        fastcgi_cache_valid 404 1m;
        fastcgi_cache_bypass $skip_cache;
        fastcgi_no_cache $skip_cache;
    }
    
    # é™æµé…ç½®
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
    
    location /api/ {
        limit_req zone=api burst=20 nodelay;
    }
    
    location /login {
        limit_req zone=login burst=5 nodelay;
    }
}
```

### MySQLé…ç½®ä¼˜åŒ–
```ini
# my.cnf MySQLæ€§èƒ½ä¼˜åŒ–é…ç½®

[mysqld]
# åŸºæœ¬é…ç½®
port = 3306
socket = /var/lib/mysql/mysql.sock
datadir = /var/lib/mysql
pid-file = /var/lib/mysql/mysql.pid

# å†…å­˜é…ç½®
innodb_buffer_pool_size = 1G
innodb_buffer_pool_instances = 8
key_buffer_size = 256M
max_connections = 200
thread_cache_size = 50

# InnoDBé…ç½®
innodb_file_per_table = 1
innodb_flush_log_at_trx_commit = 2
innodb_log_buffer_size = 16M
innodb_log_file_size = 256M
innodb_log_files_in_group = 2

# æŸ¥è¯¢ç¼“å­˜
query_cache_type = 1
query_cache_size = 128M
query_cache_limit = 2M

# ä¸´æ—¶è¡¨
tmp_table_size = 64M
max_heap_table_size = 64M

# æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = 1

# äºŒè¿›åˆ¶æ—¥å¿—
log_bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7
```

---

## ğŸ“Š æ€§èƒ½ç›‘æ§ä¸åˆ†æ

### æ€§èƒ½ç›‘æ§å®ç°
```php
/**
 * æ€§èƒ½ç›‘æ§å·¥å…·
 */
class PerformanceMonitor
{
    private static $startTime;
    private static $startMemory;
    private static $checkpoints = [];
    
    /**
     * å¼€å§‹ç›‘æ§
     */
    public static function start()
    {
        self::$startTime = microtime(true);
        self::$startMemory = memory_get_usage();
        self::$checkpoints = [];
    }
    
    /**
     * æ·»åŠ æ£€æŸ¥ç‚¹
     */
    public static function checkpoint($name)
    {
        $currentTime = microtime(true);
        $currentMemory = memory_get_usage();
        
        self::$checkpoints[] = [
            'name' => $name,
            'time' => $currentTime - self::$startTime,
            'memory' => $currentMemory - self::$startMemory,
            'peak_memory' => memory_get_peak_usage() - self::$startMemory
        ];
    }
    
    /**
     * ç»“æŸç›‘æ§å¹¶ç”ŸæˆæŠ¥å‘Š
     */
    public static function end()
    {
        $endTime = microtime(true);
        $endMemory = memory_get_usage();
        $peakMemory = memory_get_peak_usage();
        
        $report = [
            'total_time' => $endTime - self::$startTime,
            'total_memory' => $endMemory - self::$startMemory,
            'peak_memory' => $peakMemory - self::$startMemory,
            'checkpoints' => self::$checkpoints
        ];
        
        // è®°å½•æ€§èƒ½æ—¥å¿—
        self::logPerformance($report);
        
        return $report;
    }
    
    /**
     * æ•°æ®åº“æŸ¥è¯¢ç›‘æ§
     */
    public static function monitorQuery($sql, $params = [])
    {
        $startTime = microtime(true);
        
        try {
            $result = \think\Db::query($sql, $params);
            $endTime = microtime(true);
            $duration = $endTime - $startTime;
            
            // è®°å½•æ…¢æŸ¥è¯¢
            if ($duration > 1.0) { // è¶…è¿‡1ç§’çš„æŸ¥è¯¢
                self::logSlowQuery($sql, $params, $duration);
            }
            
            return $result;
        } catch (\Exception $e) {
            $endTime = microtime(true);
            $duration = $endTime - $startTime;
            
            // è®°å½•æŸ¥è¯¢é”™è¯¯
            self::logQueryError($sql, $params, $e->getMessage(), $duration);
            throw $e;
        }
    }
    
    /**
     * APIå“åº”æ—¶é—´ç›‘æ§
     */
    public static function monitorApi($controller, $action, $startTime)
    {
        $endTime = microtime(true);
        $duration = $endTime - $startTime;
        $memory = memory_get_peak_usage(true);
        
        $data = [
            'controller' => $controller,
            'action' => $action,
            'duration' => $duration,
            'memory' => $memory,
            'timestamp' => time(),
            'ip' => request()->ip(),
            'user_agent' => request()->header('User-Agent')
        ];
        
        // å¼‚æ­¥è®°å½•åˆ°æ—¥å¿—
        self::asyncLog('api_performance', $data);
        
        // æ…¢æ¥å£å‘Šè­¦
        if ($duration > 3.0) { // è¶…è¿‡3ç§’
            self::alertSlowApi($data);
        }
    }
    
    /**
     * è®°å½•æ€§èƒ½æ—¥å¿—
     */
    private static function logPerformance($report)
    {
        $logData = [
            'url' => request()->url(),
            'method' => request()->method(),
            'total_time' => round($report['total_time'] * 1000, 2) . 'ms',
            'memory_usage' => self::formatBytes($report['total_memory']),
            'peak_memory' => self::formatBytes($report['peak_memory']),
            'checkpoints' => $report['checkpoints'],
            'timestamp' => date('Y-m-d H:i:s')
        ];
        
        \think\Log::info('Performance Report: ' . json_encode($logData));
    }
    
    /**
     * è®°å½•æ…¢æŸ¥è¯¢
     */
    private static function logSlowQuery($sql, $params, $duration)
    {
        $logData = [
            'sql' => $sql,
            'params' => $params,
            'duration' => round($duration * 1000, 2) . 'ms',
            'url' => request()->url(),
            'timestamp' => date('Y-m-d H:i:s')
        ];
        
        \think\Log::warning('Slow Query: ' . json_encode($logData));
    }
    
    /**
     * å¼‚æ­¥æ—¥å¿—è®°å½•
     */
    private static function asyncLog($type, $data)
    {
        // ä½¿ç”¨é˜Ÿåˆ—å¼‚æ­¥å¤„ç†æ—¥å¿—
        \think\Queue::push('app\\common\\job\\LogJob', [
            'type' => $type,
            'data' => $data
        ]);
    }
    
    /**
     * æ ¼å¼åŒ–å­—èŠ‚æ•°
     */
    private static function formatBytes($bytes, $precision = 2)
    {
        $units = ['B', 'KB', 'MB', 'GB', 'TB'];
        
        for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
            $bytes /= 1024;
        }
        
        return round($bytes, $precision) . ' ' . $units[$i];
    }
}
```

### æ€§èƒ½åˆ†æå·¥å…·
```php
/**
 * æ€§èƒ½åˆ†æå·¥å…·
 */
class PerformanceAnalyzer
{
    /**
     * åˆ†æSQLæ€§èƒ½
     */
    public static function analyzeSQLPerformance()
    {
        $slowQueries = \think\Db::query("
            SELECT 
                query_time,
                lock_time,
                rows_sent,
                rows_examined,
                sql_text
            FROM mysql.slow_log 
            WHERE start_time >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
            ORDER BY query_time DESC
            LIMIT 10
        ");
        
        $analysis = [];
        foreach ($slowQueries as $query) {
            $analysis[] = [
                'query_time' => $query['query_time'],
                'efficiency' => $query['rows_examined'] > 0 ? $query['rows_sent'] / $query['rows_examined'] : 0,
                'sql' => substr($query['sql_text'], 0, 200),
                'suggestion' => self::getSQLOptimizationSuggestion($query)
            ];
        }
        
        return $analysis;
    }
    
    /**
     * åˆ†æå†…å­˜ä½¿ç”¨
     */
    public static function analyzeMemoryUsage()
    {
        $memoryLogs = cache('memory_usage_logs') ?: [];
        
        if (empty($memoryLogs)) {
            return ['message' => 'æš‚æ— å†…å­˜ä½¿ç”¨æ•°æ®'];
        }
        
        $avgMemory = array_sum(array_column($memoryLogs, 'memory')) / count($memoryLogs);
        $maxMemory = max(array_column($memoryLogs, 'memory'));
        $minMemory = min(array_column($memoryLogs, 'memory'));
        
        return [
            'average' => self::formatBytes($avgMemory),
            'maximum' => self::formatBytes($maxMemory),
            'minimum' => self::formatBytes($minMemory),
            'trend' => self::calculateMemoryTrend($memoryLogs),
            'recommendations' => self::getMemoryOptimizationRecommendations($avgMemory, $maxMemory)
        ];
    }
    
    /**
     * åˆ†æAPIæ€§èƒ½
     */
    public static function analyzeAPIPerformance($hours = 24)
    {
        $logs = \think\Db::name('api_performance_log')
            ->where('create_time', '>', time() - $hours * 3600)
            ->order('duration desc')
            ->select();
        
        if (empty($logs)) {
            return ['message' => 'æš‚æ— APIæ€§èƒ½æ•°æ®'];
        }
        
        $analysis = [
            'total_requests' => count($logs),
            'average_response_time' => array_sum(array_column($logs, 'duration')) / count($logs),
            'slowest_apis' => array_slice($logs, 0, 10),
            'performance_distribution' => self::calculatePerformanceDistribution($logs),
            'recommendations' => self::getAPIOptimizationRecommendations($logs)
        ];
        
        return $analysis;
    }
    
    /**
     * è·å–SQLä¼˜åŒ–å»ºè®®
     */
    private static function getSQLOptimizationSuggestion($query)
    {
        $suggestions = [];
        
        if ($query['rows_examined'] > 1000) {
            $suggestions[] = 'è€ƒè™‘æ·»åŠ ç´¢å¼•ä»¥å‡å°‘æ‰«æè¡Œæ•°';
        }
        
        if ($query['lock_time'] > 0.1) {
            $suggestions[] = 'ä¼˜åŒ–æŸ¥è¯¢ä»¥å‡å°‘é”ç­‰å¾…æ—¶é—´';
        }
        
        if ($query['rows_examined'] > 0 && $query['rows_sent'] / $query['rows_examined'] < 0.1) {
            $suggestions[] = 'æŸ¥è¯¢æ•ˆç‡è¾ƒä½ï¼Œè€ƒè™‘ä¼˜åŒ–WHEREæ¡ä»¶';
        }
        
        return implode('; ', $suggestions);
    }
    
    /**
     * è®¡ç®—å†…å­˜ä½¿ç”¨è¶‹åŠ¿
     */
    private static function calculateMemoryTrend($logs)
    {
        if (count($logs) < 2) {
            return 'stable';
        }
        
        $recent = array_slice($logs, -10);
        $earlier = array_slice($logs, 0, 10);
        
        $recentAvg = array_sum(array_column($recent, 'memory')) / count($recent);
        $earlierAvg = array_sum(array_column($earlier, 'memory')) / count($earlier);
        
        $change = ($recentAvg - $earlierAvg) / $earlierAvg;
        
        if ($change > 0.1) {
            return 'increasing';
        } elseif ($change < -0.1) {
            return 'decreasing';
        } else {
            return 'stable';
        }
    }
}
```

---

## ğŸ“‹ æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

### æ•°æ®åº“ä¼˜åŒ–æ£€æŸ¥
- [ ] ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
- [ ] é¿å…SELECT * æŸ¥è¯¢
- [ ] ä½¿ç”¨LIMITé™åˆ¶æŸ¥è¯¢ç»“æœ
- [ ] ä¼˜åŒ–JOINæŸ¥è¯¢
- [ ] ä½¿ç”¨é¢„åŠ è½½é¿å…N+1æŸ¥è¯¢
- [ ] å¯ç”¨æŸ¥è¯¢ç¼“å­˜
- [ ] å®šæœŸåˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
- [ ] ä¼˜åŒ–æ•°æ®åº“é…ç½®å‚æ•°
- [ ] ä½¿ç”¨è¯»å†™åˆ†ç¦»
- [ ] å®šæœŸä¼˜åŒ–è¡¨ç»“æ„

### ç¼“å­˜ä¼˜åŒ–æ£€æŸ¥
- [ ] å®ç°å¤šå±‚ç¼“å­˜ç­–ç•¥
- [ ] è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´
- [ ] ä½¿ç”¨ç¼“å­˜é¢„çƒ­æœºåˆ¶
- [ ] é˜²æ­¢ç¼“å­˜å‡»ç©¿å’Œé›ªå´©
- [ ] å®ç°ç¼“å­˜æ•°æ®ä¸€è‡´æ€§
- [ ] ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡
- [ ] ä¼˜åŒ–ç¼“å­˜é”®è®¾è®¡
- [ ] ä½¿ç”¨åˆ†å¸ƒå¼ç¼“å­˜
- [ ] å®ç°ç¼“å­˜é™çº§ç­–ç•¥
- [ ] å®šæœŸæ¸…ç†æ— æ•ˆç¼“å­˜

### å‰ç«¯ä¼˜åŒ–æ£€æŸ¥
- [ ] å‹ç¼©å’Œåˆå¹¶é™æ€èµ„æº
- [ ] ä½¿ç”¨CDNåŠ é€Ÿ
- [ ] å®ç°å›¾ç‰‡æ‡’åŠ è½½
- [ ] ä¼˜åŒ–å…³é”®æ¸²æŸ“è·¯å¾„
- [ ] ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜
- [ ] å‡å°‘HTTPè¯·æ±‚æ•°é‡
- [ ] ä¼˜åŒ–JavaScriptæ‰§è¡Œ
- [ ] ä½¿ç”¨Webå­—ä½“ä¼˜åŒ–
- [ ] å®ç°å“åº”å¼å›¾ç‰‡
- [ ] ä¼˜åŒ–CSSé€‰æ‹©å™¨

### æœåŠ¡å™¨ä¼˜åŒ–æ£€æŸ¥
- [ ] é…ç½®OPcache
- [ ] ä¼˜åŒ–PHPé…ç½®
- [ ] é…ç½®Nginx/Apache
- [ ] å¯ç”¨Gzipå‹ç¼©
- [ ] è®¾ç½®é€‚å½“çš„ç¼“å­˜å¤´
- [ ] ä¼˜åŒ–æ–‡ä»¶æƒé™
- [ ] ç›‘æ§æœåŠ¡å™¨èµ„æº
- [ ] å®ç°è´Ÿè½½å‡è¡¡
- [ ] é…ç½®SSL/TLS
- [ ] å®šæœŸæ›´æ–°è½¯ä»¶ç‰ˆæœ¬

---

**æ³¨æ„**: æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ï¼Œéœ€è¦æ ¹æ®å®é™…ä¸šåŠ¡åœºæ™¯å’Œæ•°æ®é‡è¿›è¡Œé’ˆå¯¹æ€§ä¼˜åŒ–ã€‚å»ºè®®åœ¨ä¼˜åŒ–å‰åéƒ½è¦è¿›è¡Œæ€§èƒ½æµ‹è¯•ï¼Œç¡®ä¿ä¼˜åŒ–æ•ˆæœã€‚