---
alwaysApply: true
priority: 0
techStack: "FastAdmin v5 + ThinkPHP"
---

# FastAdmin v5 å¼€å‘æ ‡å‡†è§„èŒƒ

> **æŠ€æœ¯æ ˆ**: FastAdmin + ThinkPHP 5.1 + Bootstrap + AdminLTE + RequireJS + Less
> **é€‚ç”¨åœºæ™¯**: åå°ç®¡ç†ç³»ç»Ÿå¼€å‘ã€CRUDå¿«é€Ÿç”Ÿæˆã€æƒé™ç®¡ç†ç³»ç»Ÿ

---

## ğŸ—ï¸ é¡¹ç›®æ¶æ„è§„èŒƒ

### ç›®å½•ç»“æ„æ ‡å‡†
```
biubiustar/
â”œâ”€â”€ addons/                 # æ’ä»¶ç›®å½•
â”œâ”€â”€ application/            # åº”ç”¨ç›®å½•
â”‚   â”œâ”€â”€ admin/             # åå°ç®¡ç†æ¨¡å—
â”‚   â”œâ”€â”€ api/               # APIæ¥å£æ¨¡å—  
â”‚   â”œâ”€â”€ index/             # å‰å°æ¨¡å—
â”‚   â””â”€â”€ common/            # å…¬å…±æ¨¡å—
â”œâ”€â”€ public/                # å…¬å…±èµ„æºç›®å½•
â”‚   â”œâ”€â”€ assets/           # é™æ€èµ„æº
â”‚   â””â”€â”€ uploads/          # ä¸Šä¼ æ–‡ä»¶
â”œâ”€â”€ extend/                # æ‰©å±•ç±»åº“
â”œâ”€â”€ runtime/               # è¿è¡Œæ—¶ç›®å½•
â”œâ”€â”€ thinkphp/              # ThinkPHPæ¡†æ¶æ ¸å¿ƒ
â””â”€â”€ vendor/                # Composerä¾èµ–
```

### æ¨¡å—ç»“æ„è§„èŒƒ
```
application/[module]/
â”œâ”€â”€ controller/            # æ§åˆ¶å™¨
â”œâ”€â”€ model/                 # æ¨¡å‹
â”œâ”€â”€ view/                  # è§†å›¾æ¨¡æ¿
â”œâ”€â”€ lang/                  # è¯­è¨€åŒ…
â”œâ”€â”€ validate/              # éªŒè¯å™¨
â”œâ”€â”€ library/               # æ¨¡å—ç±»åº“
â”œâ”€â”€ behavior/              # è¡Œä¸º
â””â”€â”€ command/               # å‘½ä»¤è¡Œ
```

---

## ğŸ“ å‘½åè§„èŒƒ

### æ–‡ä»¶å’Œç±»å‘½å
| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| **æ§åˆ¶å™¨** | å¤§é©¼å³°ï¼Œç»§æ‰¿Backend | `UserController.php` |
| **æ¨¡å‹** | å¤§é©¼å³°ï¼Œç»§æ‰¿Model | `User.php` |
| **è§†å›¾** | å°å†™+ä¸‹åˆ’çº¿ | `user/index.html` |
| **éªŒè¯å™¨** | å¤§é©¼å³° | `UserValidate.php` |
| **ä¸­é—´ä»¶** | å¤§é©¼å³° | `AuthMiddleware.php` |

### æ•°æ®åº“å‘½å
| ç±»å‹ | è§„èŒƒ | ç¤ºä¾‹ |
|------|------|------|
| **è¡¨å** | å‰ç¼€+å°å†™+ä¸‹åˆ’çº¿ | `fa_admin_user` |
| **å­—æ®µå** | å°å†™+ä¸‹åˆ’çº¿ | `user_name`, `create_time` |
| **ç´¢å¼•å** | è¡¨å_å­—æ®µå_idx | `fa_user_email_idx` |

### å˜é‡å’Œæ–¹æ³•å‘½å
```php
// âœ… æ­£ç¡®ç¤ºä¾‹
class UserController extends Backend
{
    protected $model = null;
    protected $searchFields = 'username,nickname';
    
    public function initialize()
    {
        parent::initialize();
        $this->model = new \app\admin\model\User;
    }
    
    public function getUserList($params = [])
    {
        // å®ç°é€»è¾‘
    }
}

// âŒ é”™è¯¯ç¤ºä¾‹
class usercontroller extends Backend  // å‘½åä¸è§„èŒƒ
{
    protected $m = null;              // å˜é‡åä¸æ¸…æ™°
    
    public function getdata()         // æ–¹æ³•åä¸è§„èŒƒ
    {
        // å®ç°é€»è¾‘
    }
}
```

---

## ğŸ¯ æ§åˆ¶å™¨å¼€å‘è§„èŒƒ

### Backendæ§åˆ¶å™¨æ ‡å‡†ç»“æ„
```php
<?php
namespace app\admin\controller;

use app\common\controller\Backend;
use app\admin\model\User as UserModel;
use think\Db;
use think\Exception;
use think\exception\PDOException;
use think\exception\ValidateException;

/**
 * ç”¨æˆ·ç®¡ç†æ§åˆ¶å™¨
 */
class User extends Backend
{
    /**
     * ç”¨æˆ·æ¨¡å‹å¯¹è±¡
     * @var \app\admin\model\User
     */
    protected $model = null;
    
    /**
     * å¿«é€Ÿæœç´¢å­—æ®µ
     */
    protected $searchFields = 'username,nickname,email';
    
    /**
     * å…³è”æŸ¥è¯¢
     */
    protected $relationSearch = true;
    
    /**
     * åˆå§‹åŒ–æ–¹æ³•
     */
    public function initialize()
    {
        parent::initialize();
        $this->model = new UserModel;
        
        // æƒé™æ£€æŸ¥
        $this->view->assign("statusList", $this->model->getStatusList());
    }
    
    /**
     * æŸ¥çœ‹åˆ—è¡¨
     */
    public function index()
    {
        // è®¾ç½®è¿‡æ»¤æ–¹æ³•
        $this->request->filter(['strip_tags', 'trim']);
        
        if ($this->request->isAjax()) {
            // AJAXè¯·æ±‚å¤„ç†
            return $this->selectpage();
        }
        
        return $this->view->fetch();
    }
    
    /**
     * æ·»åŠ ç”¨æˆ·
     */
    public function add()
    {
        if ($this->request->isPost()) {
            $params = $this->request->post("row/a");
            if ($params) {
                $params = $this->preExcludeFields($params);
                
                if ($this->dataLimit && $this->dataLimitFieldAutoFill) {
                    $params[$this->dataLimitField] = $this->auth->id;
                }
                
                $result = false;
                Db::startTrans();
                try {
                    $result = $this->model->allowField(true)->save($params);
                    Db::commit();
                } catch (ValidateException $e) {
                    Db::rollback();
                    $this->error($e->getMessage());
                } catch (PDOException $e) {
                    Db::rollback();
                    $this->error($e->getMessage());
                } catch (Exception $e) {
                    Db::rollback();
                    $this->error($e->getMessage());
                }
                
                if ($result !== false) {
                    $this->success();
                } else {
                    $this->error(__('No rows were inserted'));
                }
            }
            $this->error(__('Parameter %s can not be empty', ''));
        }
        
        return $this->view->fetch();
    }
}
```

### APIæ§åˆ¶å™¨æ ‡å‡†ç»“æ„
```php
<?php
namespace app\api\controller;

use app\common\controller\Api;
use app\common\model\User as UserModel;

/**
 * ç”¨æˆ·APIæ¥å£
 */
class User extends Api
{
    // æ— éœ€ç™»å½•çš„æ¥å£
    protected $noNeedLogin = ['login', 'register'];
    // æ— éœ€é‰´æƒçš„æ¥å£
    protected $noNeedRight = ['profile'];
    
    /**
     * ç”¨æˆ·ç™»å½•
     */
    public function login()
    {
        $username = $this->request->post('username');
        $password = $this->request->post('password');
        
        if (!$username || !$password) {
            $this->error(__('Invalid parameters'));
        }
        
        $ret = $this->auth->login($username, $password);
        if ($ret) {
            $data = ['userinfo' => $this->auth->getUserinfo()];
            $this->success(__('Logged in successful'), $data);
        } else {
            $this->error($this->auth->getError());
        }
    }
    
    /**
     * ç”¨æˆ·ä¿¡æ¯
     */
    public function profile()
    {
        $user = $this->auth->getUser();
        $this->success('', $user);
    }
}
```

---

## ğŸ—ƒï¸ æ¨¡å‹å¼€å‘è§„èŒƒ

### æ¨¡å‹æ ‡å‡†ç»“æ„
```php
<?php
namespace app\admin\model;

use think\Model;
use traits\model\SoftDelete;

/**
 * ç”¨æˆ·æ¨¡å‹
 */
class User extends Model
{
    use SoftDelete;
    
    // è¡¨å
    protected $name = 'user';
    
    // è‡ªåŠ¨å†™å…¥æ—¶é—´æˆ³å­—æ®µ
    protected $autoWriteTimestamp = 'int';
    
    // å®šä¹‰æ—¶é—´æˆ³å­—æ®µå
    protected $createTime = 'createtime';
    protected $updateTime = 'updatetime';
    protected $deleteTime = 'deletetime';
    
    // è¿½åŠ å±æ€§
    protected $append = [
        'status_text',
        'avatar_url'
    ];
    
    /**
     * çŠ¶æ€åˆ—è¡¨
     */
    public function getStatusList()
    {
        return ['normal' => __('Normal'), 'hidden' => __('Hidden')];
    }
    
    /**
     * çŠ¶æ€æ–‡æœ¬è·å–å™¨
     */
    public function getStatusTextAttr($value, $data)
    {
        $value = $value ? $value : (isset($data['status']) ? $data['status'] : '');
        $list = $this->getStatusList();
        return isset($list[$value]) ? $list[$value] : '';
    }
    
    /**
     * å¤´åƒURLè·å–å™¨
     */
    public function getAvatarUrlAttr($value, $data)
    {
        $avatar = $data['avatar'] ?? '';
        return $avatar ? cdnurl($avatar, true) : letter_avatar($data['nickname'] ?? '');
    }
    
    /**
     * å…³è”ç”¨æˆ·ç»„
     */
    public function group()
    {
        return $this->belongsTo('UserGroup', 'group_id', 'id', [], 'LEFT')->setEagerlyType(0);
    }
}
```

### æ•°æ®éªŒè¯è§„èŒƒ
```php
<?php
namespace app\admin\validate;

use think\Validate;

/**
 * ç”¨æˆ·éªŒè¯å™¨
 */
class User extends Validate
{
    /**
     * éªŒè¯è§„åˆ™
     */
    protected $rule = [
        'username'  => 'require|length:3,30|unique:user',
        'nickname'  => 'require|length:3,30',
        'password'  => 'require|length:6,30',
        'email'     => 'require|email|unique:user',
        'mobile'    => 'require|mobile|unique:user',
        'status'    => 'require|in:normal,hidden',
    ];
    
    /**
     * æç¤ºæ¶ˆæ¯
     */
    protected $message = [
        'username.require'   => 'Username is required',
        'username.length'    => 'Username must be 3-30 characters',
        'username.unique'    => 'Username already exists',
        'password.require'   => 'Password is required',
        'password.length'    => 'Password must be 6-30 characters',
        'email.email'        => 'Invalid email format',
        'mobile.mobile'      => 'Invalid mobile format',
    ];
    
    /**
     * éªŒè¯åœºæ™¯
     */
    protected $scene = [
        'add'  => ['username', 'nickname', 'password', 'email', 'mobile', 'status'],
        'edit' => ['nickname', 'email', 'mobile', 'status'],
    ];
}
```

---

## ğŸ¨ è§†å›¾å’Œå‰ç«¯è§„èŒƒ

### HTMLæ¨¡æ¿è§„èŒƒ
```html
<!-- ç»§æ‰¿åå°å¸ƒå±€ -->
{extend name="layout/default" /}

<!-- é¡µé¢æ ‡é¢˜ -->
{block name="title"}ç”¨æˆ·ç®¡ç†{/block}

<!-- é¡µé¢CSS -->
{block name="css"}
<style>
    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }
</style>
{/block}

<!-- é¡µé¢å†…å®¹ -->
{block name="content"}
<div class="panel panel-default panel-intro">
    <div class="panel-heading">
        <ul class="nav nav-tabs">
            <li class="active"><a href="#t-all" data-toggle="tab">å…¨éƒ¨</a></li>
            <li><a href="#t-normal" data-toggle="tab">æ­£å¸¸</a></li>
            <li><a href="#t-hidden" data-toggle="tab">éšè—</a></li>
        </ul>
    </div>
    
    <div class="panel-body">
        <div id="toolbar" class="toolbar">
            <a href="javascript:;" class="btn btn-primary btn-refresh" title="{:__('Refresh')}" ><i class="fa fa-refresh"></i> </a>
            <a href="javascript:;" class="btn btn-success btn-add {:$auth->check('user/add')?'':'hide'}" title="{:__('Add')}" ><i class="fa fa-plus"></i> {:__('Add')}</a>
            <a href="javascript:;" class="btn btn-success btn-edit btn-disabled disabled {:$auth->check('user/edit')?'':'hide'}" title="{:__('Edit')}" ><i class="fa fa-pencil"></i> {:__('Edit')}</a>
            <a href="javascript:;" class="btn btn-danger btn-del btn-disabled disabled {:$auth->check('user/del')?'':'hide'}" title="{:__('Delete')}" ><i class="fa fa-trash"></i> {:__('Delete')}</a>
        </div>
        
        <table id="table" class="table table-striped table-bordered table-hover" width="100%">
        </table>
    </div>
</div>
{/block}

<!-- é¡µé¢JS -->
{block name="js"}
<script>
    require(['backend/user/user'], function(Controller){
        Controller.index();
    });
</script>
{/block}
```

### JavaScriptæ¨¡å—è§„èŒƒ
```javascript
define(['jquery', 'bootstrap', 'backend', 'table', 'form'], function ($, undefined, Backend, Table, Form) {
    
    var Controller = {
        index: function () {
            // åˆå§‹åŒ–è¡¨æ ¼å‚æ•°é…ç½®
            Table.api.init({
                extend: {
                    index_url: 'user/index' + location.search,
                    add_url: 'user/add',
                    edit_url: 'user/edit',
                    del_url: 'user/del',
                    multi_url: 'user/multi',
                    import_url: 'user/import',
                    table: 'user',
                }
            });

            var table = $("#table");

            // åˆå§‹åŒ–è¡¨æ ¼
            table.bootstrapTable({
                url: $.fn.bootstrapTable.defaults.extend.index_url,
                pk: 'id',
                sortName: 'id',
                columns: [
                    [
                        {checkbox: true},
                        {field: 'id', title: __('Id')},
                        {field: 'username', title: __('Username'), operate: 'LIKE'},
                        {field: 'nickname', title: __('Nickname'), operate: 'LIKE'},
                        {field: 'email', title: __('Email'), operate: 'LIKE'},
                        {field: 'mobile', title: __('Mobile'), operate: 'LIKE'},
                        {field: 'avatar', title: __('Avatar'), events: Table.api.events.image, formatter: Table.api.formatter.image},
                        {field: 'status', title: __('Status'), searchList: {"normal":__('Normal'),"hidden":__('Hidden')}, formatter: Table.api.formatter.status},
                        {field: 'createtime', title: __('Createtime'), operate:'RANGE', addclass:'datetimerange', autocomplete:false, formatter: Table.api.formatter.datetime},
                        {field: 'operate', title: __('Operate'), table: table, events: Table.api.events.operate, formatter: Table.api.formatter.operate}
                    ]
                ]
            });

            // ä¸ºè¡¨æ ¼ç»‘å®šäº‹ä»¶
            Table.api.bindevent(table);
        },
        
        add: function () {
            Controller.api.bindevent();
        },
        
        edit: function () {
            Controller.api.bindevent();
        },
        
        api: {
            bindevent: function () {
                Form.api.bindevent($("form[role=form]"));
            }
        }
    };
    
    return Controller;
});
```

---

## ğŸ” å®‰å…¨å¼€å‘è§„èŒƒ

### è¾“å…¥éªŒè¯å’Œè¿‡æ»¤
```php
// âœ… æ­£ç¡®çš„è¾“å…¥å¤„ç†
public function save()
{
    // 1. è®¾ç½®è¿‡æ»¤å™¨
    $this->request->filter(['strip_tags', 'trim']);
    
    // 2. è·å–å¹¶éªŒè¯æ•°æ®
    $params = $this->request->post("row/a");
    $validate = new \app\admin\validate\User;
    
    if (!$validate->scene('add')->check($params)) {
        $this->error($validate->getError());
    }
    
    // 3. æ’é™¤å±é™©å­—æ®µ
    $params = $this->preExcludeFields($params);
    
    // 4. å¯†ç åŠ å¯†
    if (isset($params['password'])) {
        $params['password'] = password_hash($params['password'], PASSWORD_DEFAULT);
    }
}

// âŒ é”™è¯¯çš„è¾“å…¥å¤„ç†
public function save()
{
    $params = $_POST; // ç›´æ¥ä½¿ç”¨$_POSTï¼Œæœªè¿‡æ»¤
    $this->model->save($params); // æœªéªŒè¯ç›´æ¥ä¿å­˜
}
```

### SQLæ³¨å…¥é˜²æŠ¤
```php
// âœ… ä½¿ç”¨å‚æ•°ç»‘å®š
$users = Db::name('user')
    ->where('status', '=', $status)
    ->where('username', 'like', '%' . $keyword . '%')
    ->select();

// âœ… ä½¿ç”¨æ¨¡å‹æŸ¥è¯¢
$users = UserModel::where('status', $status)
    ->where('username', 'like', '%' . $keyword . '%')
    ->select();

// âŒ å­—ç¬¦ä¸²æ‹¼æ¥SQL
$sql = "SELECT * FROM user WHERE username = '{$username}'"; // å±é™©ï¼
```

### æƒé™æ§åˆ¶
```php
// æ§åˆ¶å™¨æƒé™æ£€æŸ¥
class User extends Backend
{
    public function edit()
    {
        // æ£€æŸ¥ç¼–è¾‘æƒé™
        if (!$this->auth->check('user/edit')) {
            $this->error(__('You have no permission'));
        }
        
        // æ•°æ®æƒé™é™åˆ¶
        if ($this->dataLimit) {
            $this->model->where($this->dataLimitField, $this->auth->id);
        }
    }
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–è§„èŒƒ

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
```php
// âœ… ä½¿ç”¨ç´¢å¼•å’Œé™åˆ¶æŸ¥è¯¢
$users = UserModel::field('id,username,nickname')
    ->where('status', 'normal')
    ->limit(10)
    ->order('id desc')
    ->select();

// âœ… é¢„åŠ è½½å…³è”
$users = UserModel::with(['group'])
    ->where('status', 'normal')
    ->select();

// âœ… ä½¿ç”¨ç¼“å­˜
$users = cache('user_list_' . $page, function() use ($page) {
    return UserModel::where('status', 'normal')
        ->page($page, 10)
        ->select();
}, 300);

// âŒ é¿å…N+1æŸ¥è¯¢
foreach ($users as $user) {
    echo $user->group->name; // æ¯æ¬¡å¾ªç¯éƒ½æŸ¥è¯¢æ•°æ®åº“
}
```

### å‰ç«¯èµ„æºä¼˜åŒ–
```javascript
// âœ… æŒ‰éœ€åŠ è½½æ¨¡å—
define(['jquery', 'bootstrap'], function ($) {
    // åªåŠ è½½å¿…è¦çš„ä¾èµ–
});

// âœ… ä½¿ç”¨CDNèµ„æº
<link rel="stylesheet" href="//cdn.bootcdn.net/ajax/libs/bootstrap/3.4.1/css/bootstrap.min.css">

// âœ… å‹ç¼©å’Œåˆå¹¶èµ„æº
// ä½¿ç”¨FastAdminçš„å‹ç¼©å‘½ä»¤
php think min -m backend -r all
```

---

## ğŸ§ª æµ‹è¯•è§„èŒƒ

### å•å…ƒæµ‹è¯•
```php
<?php
namespace tests\unit;

use app\admin\model\User as UserModel;
use think\testing\TestCase;

class UserTest extends TestCase
{
    public function testUserCreate()
    {
        $user = new UserModel();
        $result = $user->save([
            'username' => 'testuser',
            'password' => password_hash('123456', PASSWORD_DEFAULT),
            'email' => 'test@example.com',
            'status' => 'normal'
        ]);
        
        $this->assertTrue($result);
        $this->assertEquals('testuser', $user->username);
    }
    
    public function testUserValidation()
    {
        $validate = new \app\admin\validate\User;
        $result = $validate->check([
            'username' => 'te', // å¤ªçŸ­
            'email' => 'invalid-email' // æ— æ•ˆé‚®ç®±
        ]);
        
        $this->assertFalse($result);
    }
}
```

---

## ğŸ“¦ éƒ¨ç½²å’Œç»´æŠ¤è§„èŒƒ

### ç¯å¢ƒé…ç½®
```php
// .env æ–‡ä»¶é…ç½®
APP_DEBUG = false
APP_TRACE = false

DATABASE_TYPE = mysql
DATABASE_HOSTNAME = 127.0.0.1
DATABASE_DATABASE = fastadmin
DATABASE_USERNAME = root
DATABASE_PASSWORD = 
DATABASE_HOSTPORT = 3306

REDIS_HOSTNAME = 127.0.0.1
REDIS_PORT = 6379
```

### æ—¥å¿—è®°å½•
```php
// è®°å½•æ“ä½œæ—¥å¿—
\app\admin\model\AdminLog::record([
    'title' => 'ç”¨æˆ·ç®¡ç†',
    'content' => 'æ·»åŠ ç”¨æˆ·ï¼š' . $username,
    'url' => $this->request->url()
]);

// è®°å½•é”™è¯¯æ—¥å¿—
\think\Log::error('User creation failed: ' . $e->getMessage());
```

---

## ğŸ¯ ä»£ç è´¨é‡æ£€æŸ¥

### å¿…é¡»éµå¾ªçš„è§„åˆ™
1. **æ‰€æœ‰æ§åˆ¶å™¨å¿…é¡»ç»§æ‰¿å¯¹åº”çš„åŸºç±»**ï¼ˆBackend/Frontend/Apiï¼‰
2. **æ‰€æœ‰æ•°æ®åº“æ“ä½œå¿…é¡»ä½¿ç”¨äº‹åŠ¡**
3. **æ‰€æœ‰ç”¨æˆ·è¾“å…¥å¿…é¡»éªŒè¯å’Œè¿‡æ»¤**
4. **æ‰€æœ‰æ•æ„Ÿæ“ä½œå¿…é¡»è®°å½•æ—¥å¿—**
5. **æ‰€æœ‰æ–‡ä»¶ä¸Šä¼ å¿…é¡»æ£€æŸ¥ç±»å‹å’Œå¤§å°**
6. **æ‰€æœ‰APIæ¥å£å¿…é¡»æœ‰æƒé™æ§åˆ¶**
7. **æ‰€æœ‰SQLæŸ¥è¯¢å¿…é¡»ä½¿ç”¨å‚æ•°ç»‘å®š**
8. **æ‰€æœ‰ç¼“å­˜é”®å¿…é¡»æœ‰åˆç†çš„è¿‡æœŸæ—¶é—´**

### ä»£ç å®¡æŸ¥è¦ç‚¹
- [ ] æ˜¯å¦éµå¾ªMVCæ¶æ„
- [ ] æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„å‘½åè§„èŒƒ
- [ ] æ˜¯å¦è¿›è¡Œäº†è¾“å…¥éªŒè¯
- [ ] æ˜¯å¦æœ‰SQLæ³¨å…¥é£é™©
- [ ] æ˜¯å¦æœ‰XSSæ¼æ´
- [ ] æ˜¯å¦æœ‰æƒé™æ§åˆ¶
- [ ] æ˜¯å¦æœ‰é”™è¯¯å¤„ç†
- [ ] æ˜¯å¦æœ‰æ€§èƒ½é—®é¢˜

---

**æ³¨æ„**: æœ¬è§„èŒƒåŸºäºFastAdminæ¡†æ¶çš„æœ€ä½³å®è·µï¼Œå¼€å‘æ—¶åº”ä¸¥æ ¼éµå¾ªä»¥ç¡®ä¿ä»£ç è´¨é‡å’Œå®‰å…¨æ€§ã€‚